# –°–≤–æ–¥–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π ‚Äî –í–µ–±-–ø–æ–∏—Å–∫ Perplexity Sonar

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –º–æ–¥–µ–ª–µ–π Perplexity Sonar —Å –≤–∫–ª—é—á—ë–Ω–Ω–æ–π –≥–∞–ª–∫–æ–π "Search" –≤–µ–±-–ø–æ–∏—Å–∫ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è. –ú–æ–¥–µ–ª—å –æ—Ç–≤–µ—á–∞–ª–∞: "–Ø –Ω–µ –º–æ–≥—É –∑–∞–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç—ã..." –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–Ω–∞–Ω–∏—è.

### –ü—Ä–∏—á–∏–Ω–∞
OpenAI SDK –≤–µ—Ä—Å–∏–∏ 1.x –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ `extra_json`, –Ω–æ **–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∏—Ö** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è API. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ Perplexity –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è **—è–≤–Ω–æ —á–µ—Ä–µ–∑ `extra_body`**.

### –†–µ—à–µ–Ω–∏–µ
1. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–∏—Å–∫–∞** ‚Äî –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (`enable_search_classifier`, `search_mode`, `web_search_options` –∏ –¥—Ä.) —Ç–µ–ø–µ—Ä—å –∏–¥—É—Ç —á–µ—Ä–µ–∑ `extra_body`
2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞** ‚Äî `disable_search` —Ç–∞–∫–∂–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ `extra_body`
3. **–î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî `usage.num_search_queries`, `search_context_size` –∏ —Å–ø–∏—Å–æ–∫ `search_results[]`
4. **–û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** ‚Äî —Å–æ–∑–¥–∞–Ω–∞ –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

## üì¶ –ö–æ–º–º–∏—Ç—ã

### –ö–æ–º–º–∏—Ç 1: `de43c29`
- –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∏—Å—å –Ω–∞–ø—Ä—è–º—É—é, —á—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ)

### –ö–æ–º–º–∏—Ç 2: `72038c5` ‚≠ê (—Ç–µ–∫—É—â–∏–π)
- **–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–µ—Ä–µ–∑ `extra_body`
- –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ `docs/PERPLEXITY_SEARCH_FIX.md`
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –≤ `docs/TESTING_PERPLEXITY_SEARCH.md`

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

```
4 files changed, 166 insertions(+), 32 deletions(-)

webapp/services/search/manager.py  - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ extra_body
webapp/services/rag_service.py     - RAG –∞–Ω–∞–ª–∏–∑ —Å –ø–æ–∏—Å–∫–æ–º
webapp/routes/ai_rag.py            - –ø—Ä—è–º–æ–π –∞–Ω–∞–ª–∏–∑ (3 –±–ª–æ–∫–∞)
docs/PERPLEXITY_SEARCH_FIX.md      - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
docs/TESTING_PERPLEXITY_SEARCH.md  - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
```

## üß™ –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç

1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä**
2. **–í—ã–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å**: `sonar` –∏–ª–∏ `sonar-pro`
3. **–í–∫–ª—é—á–∏—Ç—å –≥–∞–ª–∫—É "Search"**
4. **–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å**: "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ 44-–§–ó –ø–æ –∑–∞–∫—É–ø–∫–∞–º"
5. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏**:
   ```bash
   tail -f logs/app.log | grep -E "(üåê|üîç|‚úÖ)"
   ```

### –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:
```
üåê –†–µ–∂–∏–º –° –ü–û–ò–°–ö–û–ú: extra_body = {'enable_search_classifier': True, ...}
üîç Search usage: num_search_queries=3, search_context_size=1234
‚úÖ –ü–æ–∏—Å–∫ –ë–´–õ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω
üîó –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–æ–∏—Å–∫–∞ (3 –≤—Å–µ–≥–æ): ...
```

## üìù –î–µ–ª—å—Ç–∞ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∫–æ–º–º–∏—Ç–æ–º

**–û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–º–º–∏—Ç–µ `72038c5`:**

1. `webapp/services/search/manager.py`:
   - –§—É–Ω–∫—Ü–∏—è `apply_search_to_request()` —Ç–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞—ë—Ç `extra_body` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–π –∑–∞–ø–∏—Å–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

2. `webapp/services/rag_service.py`:
   - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–¥—É—Ç —á–µ—Ä–µ–∑ `extra_body`
   - `disable_search` —Ç–æ–∂–µ —á–µ—Ä–µ–∑ `extra_body`
   - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ usage-–º–µ—Ç—Ä–∏–∫

3. `webapp/routes/ai_rag.py`:
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã 3 –±–ª–æ–∫–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π + 2 retry)
   - –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–µ—Ä–µ–∑ `extra_body`
   - –§–æ–ª–±—ç–∫ –¥–ª—è `extra_body` –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

4. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
   - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è
   - –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
   - –ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤ –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏

## üéØ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥

**–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ UI** ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ —Å –≤–∫–ª—é—á—ë–Ω–Ω—ã–º –ø–æ–∏—Å–∫–æ–º –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ:
- –í –ª–æ–≥–∞—Ö –ø–æ—è–≤–ª—è–µ—Ç—Å—è `üåê –†–µ–∂–∏–º –° –ü–û–ò–°–ö–û–ú`
- –ú–æ–¥–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∏
- –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —É–∫–∞–∑–∞–Ω–æ "–ú–æ–¥–µ–ª—å: sonar + Search"

## üìö –°–ø—Ä–∞–≤–æ—á–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

- **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `docs/PERPLEXITY_SEARCH_FIX.md`
- **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é**: `docs/TESTING_PERPLEXITY_SEARCH.md`
- **API Perplexity**: https://docs.perplexity.ai/api-reference/chat-completions-post

---

**–î–∞—Ç–∞**: 2 –Ω–æ—è–±—Ä—è 2025 –≥.  
**–ê–≤—Ç–æ—Ä**: GitHub Copilot  
**–•–µ—à –∫–æ–º–º–∏—Ç–∞**: `72038c5`

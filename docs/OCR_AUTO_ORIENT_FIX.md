# Исправление распознавания документов-изображений

## Дата: 18 октября 2025 г.

## Проблема

Не работает распознавание PDF-документов, отсканированных как изображения. Основные причины:

1. **Отсутствие системных зависимостей**: Tesseract OCR не был установлен в системе
2. **Отсутствие Python-библиотек**: pytesseract и pdf2image не были установлены
3. **Отсутствие автокоррекции ориентации**: документы, отсканированные в альбомной ориентации или перевёрнутые, не распознавались корректно

## Решение

### 1. Установка зависимостей

Добавлены инструкции по установке Tesseract OCR для разных платформ в файл `docs/TESSERACT_INSTALL.md`.

**Для macOS:**
```bash
brew install tesseract tesseract-lang poppler
pip3 install pytesseract pdf2image
```

### 2. Автоматическая коррекция ориентации

Добавлен метод `_auto_orient_image()` в `document_processor/pdf_reader/reader.py`, который:

- Пробует распознать изображение в 4 ориентациях (0°, 90°, 180°, 270°)
- Использует OSD (Orientation and Script Detection) Tesseract для автоматического определения ориентации
- Если OSD не доступен, пробует распознать текст в каждой ориентации и выбирает ту, где получено больше всего текста
- Автоматически поворачивает изображение для оптимального распознавания

**Код изменений:**

```python
def _auto_orient_image(self, img: Any, lang: str) -> Any:
    """Автоматическая коррекция ориентации изображения для OCR."""
    # Пробует 4 угла: 0°, 90°, 180°, 270°
    # Использует OSD или выбирает ориентацию с максимальным текстом
    # Возвращает изображение с оптимальной ориентацией
```

### 3. Интеграция в OCR-конвейер

Метод `_extract_text_ocr()` теперь вызывает `_auto_orient_image()` для каждой страницы перед распознаванием:

```python
# Автокоррекция ориентации изображения
img_corrected = self._auto_orient_image(img, lang)
t = pytesseract.image_to_string(img_corrected, lang=lang)
```

### 4. Тесты

Добавлен файл `tests/test_ocr_auto_orient.py` с тестами:
- `test_auto_orient_basic()` — базовый тест метода автокоррекции
- `test_ocr_with_auto_orient()` — тест на реальном PDF-файле
- `test_ocr_different_orientations()` — тест распознавания в разных ориентациях

## Файлы изменены

1. **document_processor/pdf_reader/reader.py**
   - Добавлен метод `_auto_orient_image()` (75 строк)
   - Изменён метод `_extract_text_ocr()` для использования автокоррекции

2. **docs/TESSERACT_INSTALL.md** (новый файл)
   - Инструкции по установке Tesseract для macOS, Linux
   - Решение типовых проблем
   - Проверка работоспособности

3. **tests/test_ocr_auto_orient.py** (новый файл)
   - Тесты автокоррекции ориентации
   - Тесты OCR с реальными документами

## Как проверить

### Шаг 1: Установите Tesseract

```bash
brew install tesseract tesseract-lang poppler
```

### Шаг 2: Установите Python-зависимости

```bash
pip3 install pytesseract pdf2image
```

### Шаг 3: Проверьте установку

```bash
tesseract --version
```

### Шаг 4: Запустите тест

```bash
cd /Users/maksimyarikov/Desktop/Автоматизация\ закупок/Код/web_interface
python3 -c "
from document_processor.pdf_reader import PdfReader
reader = PdfReader()
result = reader.read_pdf('/Users/maksimyarikov/Desktop/Автоматизация закупок/Исходные данные/Пример документов по закупке/PDF/ТЗ поставка сплит-систем.pdf', ocr='force', max_pages_ocr=2)
print(f'OCR использован: {result[\"ocr_used\"]}')
print(f'Извлечено символов: {len(result[\"text\"])}')
print(f'Первые 500 символов:\\n{result[\"text\"][:500]}')
"
```

## Ожидаемый результат

После установки Tesseract OCR:
- ✅ PDF-сканы распознаются автоматически
- ✅ Документы в любой ориентации (0°, 90°, 180°, 270°) распознаются корректно
- ✅ Автоматический выбор оптимальной ориентации для распознавания
- ✅ Логирование процесса распознавания и поворота изображений

## Производительность

- Автокоррекция ориентации добавляет ~2-4 секунды на страницу (пробует до 4 ориентаций)
- Использование OSD ускоряет процесс (1 проверка вместо 4)
- Ограничение `max_pages_ocr=2` по умолчанию для контроля времени обработки

## Graceful degradation

Если Tesseract не установлен:
- Модуль не падает, а логирует предупреждение
- Возвращает пустой текст с информацией об ошибке
- Приложение продолжает работать с векторными PDF

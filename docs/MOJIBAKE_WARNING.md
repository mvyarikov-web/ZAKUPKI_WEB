# Предупреждение о битых символах в AI анализе

## Обзор изменений (01.11.2025)

Добавлено автоматическое предупреждение о наличии битых символов (кракозябр) в окне AI анализа.

## Проблема

Пользователи могли не замечать, что в текст попали битые символы из-за неправильной кодировки (например: `–∂—ë–a—ã–μ–æ–ø`), которые:
- Увеличивают количество токенов без пользы
- Затрудняют анализ для AI
- Тратят деньги на обработку мусора

## Решение

Добавлена функция автоматической проверки текста на наличие битых символов с визуальным предупреждением.

### Визуальное отображение

Если в промпте или документах обнаружены битые символы, под основной информацией появляется **жёлтое предупреждение**:

```
⚠️ Много битых символов, рекомендуется оптимизация!
```

Стиль предупреждения:
- **Цвет текста**: оранжевый (`#f57c00`)
- **Фон**: светло-оранжевый (`#fff3e0`)
- **Иконка**: ⚠️
- **Оформление**: закруглённая плашка с отступами

## Технические детали

### Функция детекции битых символов

```javascript
function detectMojibake(text) {
    // Паттерн для длинных последовательностей битых символов (минимум 8 подряд)
    const mojibakePattern = /[–∂—ë–a—ã–μ–æ–ø–μ—Ä–∞—Ü–∏–∏...]{8,}/;
    
    // Паттерн для характерных последовательностей битого текста
    const garbagePattern = /[–]{2,}[∂—ë]+[–]{2,}|[–∂—ë–a—ã–μ–æ–ø]{10,}/;
    
    return mojibakePattern.test(text) || garbagePattern.test(text);
}
```

### Критерии обнаружения

1. **Минимум 8 специфических символов подряд** из набора:
   - `–`, `∂`, `—`, `ë`, `–a`, `—ã`, `–μ`, `–æ`, `–ø` и т.д.
   - Это символы, которые появляются при неправильной интерпретации UTF-8

2. **Характерные последовательности**:
   - `––∂—ë––` (тире + битые символы + тире)
   - Минимум 10 битых символов из списка

### Интеграция в updateRagMetrics()

```javascript
function updateRagMetrics() {
    // ... расчёт метрик ...
    
    // Проверяем наличие битых символов
    const fullText = prompt + '\n\n' + docs;
    const hasMojibake = detectMojibake(fullText);
    
    if (hasMojibake) {
        // Добавляем предупреждение HTML с жёлтым стилем
        ragMetrics.innerHTML = info + 
            '<br><span style="color: #f57c00; font-weight: 600; ' +
            'background: #fff3e0; padding: 4px 8px; border-radius: 4px; ' +
            'display: inline-block; margin-top: 8px;">' +
            '⚠️ Много битых символов, рекомендуется оптимизация!</span>';
    } else {
        ragMetrics.textContent = info;
    }
}
```

## User Experience

### До изменений
```
Модель: GPT-4o. Символы: промпт 120, документы 99846, всего 99966.
Токены (оценка): вход 24992, выход 2500, всего 27492.
Стоимость: $0.0625
```
Пользователь не знает, что часть текста — мусор.

### После изменений
```
Модель: GPT-4o. Символы: промпт 120, документы 99846, всего 99966.
Токены (оценка): вход 24992, выход 2500, всего 27492.
Стоимость: $0.0625

⚠️ Много битых символов, рекомендуется оптимизация!
```
Пользователь видит предупреждение и может:
1. Нажать кнопку "⚡ Оптимизировать текст"
2. Очистить текст от кракозябр автоматически
3. Сэкономить токены и деньги

## Примеры битых символов

Что детектируется:
- `–∂—ë–a—ã–μ–æ–ø–μ—Ä–∞—Ü–∏–∏` ✅
- `–ú–∏–Ω–∏–o–∞–a—å–Ω—ã–μ` ✅
- `––∂—ë––` (короткая последовательность с тире) ✅
- Обычный текст на кириллице ❌ (не детектируется)

## Преимущества

✅ **Автоматическое обнаружение** — пользователь не пропустит проблему
✅ **Визуальная заметность** — жёлтая плашка привлекает внимание
✅ **Экономия токенов** — напоминание об оптимизации
✅ **Простота** — не требует дополнительных действий пользователя
✅ **Не мешает работе** — только информационное сообщение

## Совместимость

- Работает со всеми моделями (GPT, o1, DeepSeek)
- Не влияет на расчёт токенов и стоимости
- Интегрируется с существующей функцией `updateRagMetrics()`
- Паттерны совпадают с теми, что используются в `text_optimizer.py`

## Связь с оптимизатором

Предупреждение использует **те же паттерны**, что и оптимизатор текста:
- `webapp/services/text_optimizer.py` — удаляет битые символы
- `static/js/rag-analysis.js` — детектирует и предупреждает

Пользователь видит предупреждение → нажимает "⚡ Оптимизировать текст" → битые символы удаляются → предупреждение исчезает.

## Изменённые файлы

- `static/js/rag-analysis.js`:
  - Добавлена функция `detectMojibake(text)`
  - Обновлена функция `updateRagMetrics()` для проверки и отображения предупреждения

## Тестирование

1. Откройте AI анализ
2. Вставьте текст с битыми символами (например: `–∂—ë–a—ã–μ–æ–ø–μ—Ä`)
3. Проверьте, что появляется жёлтое предупреждение
4. Удалите битые символы
5. Проверьте, что предупреждение исчезает

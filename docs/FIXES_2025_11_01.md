# Исправления и улучшения (01.11.2025)

## Обзор изменений

Три критических исправления в функциональности AI-анализа и оптимизации текста.

## 1. Глубокий анализ теперь всегда включён

### Проблема
Пользователю приходилось вручную включать чекбокс "Глубокий анализ" для каждого запроса.

### Решение
- ✅ Удалён чекбокс "Глубокий анализ" из UI
- ✅ Глубокий анализ теперь выполняется автоматически для всех запросов
- ✅ Обновлены лимиты токенов:
  - **o1 / deepseek-reasoner**: 16000 токенов (было 4000-8000)
  - **Остальные модели**: 2500 токенов (было 1500)

### Изменённые файлы
- `templates/index.html` - удалён чекбокс
- `static/js/rag-analysis.js` - `deep = true` всегда

---

## 2. Увеличен лимит токенов для deepseek-reasoner

### Проблема
Модель deepseek-reasoner обрезала ответы из-за ограничения в 2500 токенов:
```
⚠️ Примечание: Ответ был обрезан из-за ограничения длины. 
Увеличьте параметр max_output_tokens для получения полного ответа.
```

### Решение
- ✅ Увеличен `max_output_tokens` для deepseek-reasoner до **16000 токенов**
- ✅ Модель теперь обрабатывается как o1-серия (длинные рассуждения)
- ✅ Обновлена оценка токенов в калькуляторе стоимости: **8000 токенов** для ожидаемого вывода

### Технические детали
```javascript
// Было:
if (selectedModelId && selectedModelId.startsWith('o1')) {
    maxTokens = 8000;
}

// Стало:
if (selectedModelId && (selectedModelId.startsWith('o1') || selectedModelId === 'deepseek-reasoner')) {
    maxTokens = 16000;
}
```

### Изменённые файлы
- `static/js/rag-analysis.js` - логика определения лимитов токенов

---

## 3. Гибкое выделение текста в оптимизаторе

### Проблема
- ❌ Выделение работало только целыми блоками (span'ами)
- ❌ Невозможно выделить произвольный фрагмент текста
- ❌ Клик по подсветке иногда не снимал её
- ❌ Выделение захватывало больше текста, чем нужно

### Решение
Полностью переработана система выделения текста:

#### Новая механика
1. **Выделение мышкой** (как в обычном редакторе):
   - Выделите любой фрагмент текста → он подсветится жёлтым
   - Можно выделять сколько угодно фрагментов
   - Выделение работает с произвольными границами (не привязано к блокам)

2. **Снятие подсветки**:
   - Кликните по жёлтой подсветке → она исчезнет
   - Работает для любой подсветки (исходной или пользовательской)
   - Можно снимать подсветку частично, выделив нужный фрагмент

3. **Навигация**:
   - Кнопки "↑ Назад" / "↓ Вперёд" учитывают все подсветки
   - Счётчик показывает общее количество подсветок

#### Технические детали
- `window.getSelection()` для получения выделенного текста
- `range.surroundContents()` для обёртки в `<span>` с подсветкой
- Уникальные ID для каждой подсветки: `hl-{timestamp}-{random}`
- Умная обработка пересечений и вложенных элементов

#### Обработка ошибок
- Fallback через `range.extractContents()` если `surroundContents()` не сработал
- Корректная работа с пересекающимися подсветками
- Безопасное удаление подсветок без потери текста

### Изменённые файлы
- `static/js/text-optimizer.js`:
  - `setupClickHandlers()` - переработана логика
  - `toggleSelectionHighlight()` - новая функция для обработки выделения
  - `addHighlightToRange()` - добавление подсветки к Range
  - `removeHighlightFromRange()` - удаление подсветок из Range
  - `buildOptimizedTextFromDOM()` - рекурсивный сбор текста
  - `navigateToHighlight()` - обновлённая логика навигации

- `templates/index.html`:
  - Обновлена подсказка: "Выделите мышкой любой текст..."

---

## Итоги

### Что работает теперь
✅ Глубокий анализ включён по умолчанию (без чекбокса)
✅ DeepSeek Reasoner получает полные ответы (16K токенов)
✅ Гибкое выделение текста как в текстовом редакторе
✅ Надёжное снятие подсветок кликом
✅ Произвольные границы выделения (не по блокам)

### Совместимость
- Все современные браузеры (Chrome, Firefox, Safari, Edge)
- Selection API для выделения текста
- Range API для манипуляции с DOM

### Что протестировать
1. Запустите AI-анализ с deepseek-reasoner - проверьте, что ответ полный
2. Откройте оптимизатор текста:
   - Выделите произвольный текст мышкой → должна появиться жёлтая подсветка
   - Кликните по подсветке → она должна исчезнуть
   - Выделите несколько фрагментов → навигация должна работать
3. Примените оптимизацию → проверьте, что подсвеченные фрагменты удалены

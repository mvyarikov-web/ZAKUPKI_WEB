# RAG-анализ документов закупок

Модуль RAG (Retrieval-Augmented Generation) для углубленного анализа документов закупок с использованием векторного поиска и генеративных моделей.

## Возможности

- 🔍 **Семантический поиск** по содержимому документов
- 🤖 **Структурированные ответы** (summary, equipment, installation)
- 💰 **Управление стоимостью** через UI (оценка до запроса, фактический расход)
- 📊 **Гибкая настройка**: выбор модели, Top-K, ручной ввод цен
- 🌐 **Русская локализация** всего интерфейса
- ⚡ **Graceful degradation** при отсутствии PostgreSQL

## Быстрый старт

### 1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 2. Настройка PostgreSQL

#### Вариант A: Локальная установка

**Ubuntu/Debian:**
```bash
sudo apt-get update
sudo apt-get install postgresql-16 postgresql-16-pgvector
sudo systemctl start postgresql
```

**macOS:**
```bash
brew install postgresql pgvector
brew services start postgresql
```

#### Вариант B: Docker

```bash
docker run -d \
  --name zakupki-postgres \
  -e POSTGRES_PASSWORD=postgres \
  -e POSTGRES_DB=zakupki_rag \
  -p 5432:5432 \
  ankane/pgvector:latest
```

### 3. Создание базы данных

```bash
# Создать базу (если ещё не создана)
createdb zakupki_rag

# Или через psql
psql -U postgres -c "CREATE DATABASE zakupki_rag;"
```

### 4. Настройка переменных окружения

Создайте файл `.env` в корне проекта:

```bash
# OpenAI API ключ (обязательно)
OPENAI_API_KEY=sk-your-api-key-here

# PostgreSQL (опционально, дефолт ниже)
DATABASE_URL=postgresql://postgres:password@localhost:5432/zakupki_rag

# RAG настройки (опционально)
RAG_ENABLED=true
RAG_CHUNK_SIZE=2000
RAG_TOP_K=5
RAG_EMBEDDING_MODEL=text-embedding-3-small
RAG_DEFAULT_MODEL=gpt-4o-mini
```

### 5. Инициализация базы данных

```bash
python scripts/init_rag_db.py
```

**Ожидаемый вывод:**
```
============================================================
Инициализация базы данных для RAG
============================================================

1. Подключение к базе данных...
   ✓ Подключение установлено

2. Создание расширений и таблиц...
   ✓ Расширение pgvector установлено
   ✓ Таблица documents создана
   ✓ Таблица chunks создана
   ✓ Индексы созданы

3. Проверка статистики...
   Документов в базе: 0
   Чанков в базе: 0

============================================================
✓ Инициализация завершена успешно!
============================================================
```

### 6. Запуск приложения

```bash
python app.py
```

Откройте http://127.0.0.1:8081 в браузере.

## Использование

### 1. Индексация документов

1. Загрузите документы через кнопку "Открыть файлы" или "Открыть папку"
2. Отметьте чекбоксами нужные файлы
3. Нажмите **"Индексировать"** в секции "AI-анализ (RAG)"
4. Дождитесь завершения (статус отобразится в сообщении)

### 2. Настройка модели и цен

1. Нажмите **"Анализ RAG"**
2. В открывшемся окне нажмите **"Модель"**
3. Выберите нужную модель из списка
4. Введите цены:
   - **Цена входных токенов** (за 1M токенов)
   - **Цена выходных токенов** (за 1M токенов)
5. Нажмите **"Сохранить"**

### 3. Выполнение RAG-анализа

1. Выберите проиндексированные файлы (чекбоксы)
2. Нажмите **"Анализ RAG"**
3. Отредактируйте промпт (если нужно)
4. Настройте параметры:
   - **Top-K фрагментов**: 3-10 (больше = дороже + полнее)
   - **Макс. выходных токенов**: 0-2000 (0 = по умолчанию модели)
5. Нажмите **"Оценить"** для предварительного расчёта
6. Нажмите **"Начать анализ"**
7. Дождитесь результата (10-30 сек)

### 4. Результаты анализа

Структурированный ответ включает:

#### Summary (краткая выжимка)
- До 10 ключевых пунктов
- Краткое описание закупки

#### Equipment (список оборудования)
- Название и модель
- Характеристики (мощность, производительность и т.д.)
- Количество и единицы измерения
- Цитаты-подтверждения из документов

#### Installation (монтаж)
- **Вердикт**: Требуется / Не требуется / Неизвестно
- **Подтверждения**: короткие цитаты с упоминанием монтажа, ПНР, шеф-монтажа и т.д.

#### Фактический расход
- Входные токены
- Выходные токены
- Общее количество токенов
- Стоимость (по введённым ценам)

## Архитектура

```
┌─────────────────────────────────────────────────────────┐
│                    Web Interface                        │
│  (templates/index.html + static/js/rag-analysis.js)    │
└─────────────────┬───────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────┐
│                 Flask Routes                            │
│              (webapp/routes/ai_rag.py)                  │
│                                                          │
│  /ai_rag/models  - Управление моделями                  │
│  /ai_rag/estimate - Оценка запроса                      │
│  /ai_rag/index   - Индексация документов                │
│  /ai_rag/analyze - Выполнение RAG-анализа               │
│  /ai_rag/status  - Статус системы                       │
└─────────────────┬───────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────┐
│                  RAG Service                            │
│           (webapp/services/rag_service.py)              │
│                                                          │
│  • index_document()    - Индексация                     │
│  • search_and_analyze() - Поиск + генерация             │
│  • _postprocess_result() - Постобработка                │
└──────┬──────────┬──────────────┬─────────────────────────┘
       │          │              │
┌──────▼─────┐ ┌─▼─────────┐ ┌──▼────────────────────────┐
│ Chunking   │ │ Embeddings│ │  PostgreSQL + pgvector    │
│  Service   │ │  Service  │ │                           │
│            │ │           │ │ • documents (metadata)    │
│ • chunk_   │ │ • get_    │ │ • chunks (text+vectors)   │
│   document │ │   embedding│ │ • IVFFlat index           │
│ • clean_   │ │ • batch   │ │ • Cosine similarity       │
│   text     │ │   processing│ │   search                 │
└────────────┘ └───────────┘ └───────────────────────────┘
```

## Конфигурация

### Параметры RAG (webapp/config.py)

```python
# Включение/выключение RAG
RAG_ENABLED = True

# Размер чанка в токенах (рекомендуется 1500-3000)
RAG_CHUNK_SIZE = 2000

# Overlap в предложениях (для сохранения контекста)
RAG_CHUNK_OVERLAP = 3

# Количество чанков для контекста (больше = дороже + полнее)
RAG_TOP_K = 5

# Минимальный порог сходства (0-1, рекомендуется 0.6-0.8)
RAG_MIN_SIMILARITY = 0.7

# Модель эмбеддингов
RAG_EMBEDDING_MODEL = 'text-embedding-3-small'

# Модель генерации по умолчанию
RAG_DEFAULT_MODEL = 'gpt-4o-mini'

# Максимум выходных токенов
RAG_MAX_OUTPUT_TOKENS = 600

# Температура (детерминизм: 0.0-0.5, креативность: 0.6-1.0)
RAG_TEMPERATURE = 0.3
```

### Модели (index/models.json)

```json
{
  "models": [
    {
      "model_id": "gpt-4o-mini",
      "display_name": "GPT-4o Mini (экономный)",
      "context_window_tokens": 128000,
      "price_input_per_1m": 0.15,
      "price_output_per_1m": 0.60,
      "enabled": true,
      "description": "Примерные цены. Обновите через UI после проверки актуальных тарифов."
    },
    {
      "model_id": "gpt-4-turbo",
      "display_name": "GPT-4 Turbo",
      "context_window_tokens": 128000,
      "price_input_per_1m": 10.0,
      "price_output_per_1m": 30.0,
      "enabled": true,
      "description": "Примерные цены. Обновите через UI после проверки актуальных тарифов."
    }
  ],
  "default_model": "gpt-4o-mini",
  "note": "Цены указаны приблизительно. Обновите их через UI после проверки актуальных тарифов на https://openai.com/pricing"
}
```

## Тестирование

### Запуск тестов

```bash
# Все тесты чанкования (не требуют внешних сервисов)
python -m pytest tests/test_rag_module.py::TestChunking -v

# Тесты эмбеддингов (требуют OPENAI_API_KEY)
export OPENAI_API_KEY=sk-...
python -m pytest tests/test_rag_module.py::TestEmbeddings -v

# Интеграционные тесты (требуют PostgreSQL)
export DATABASE_URL='postgresql://postgres:password@localhost:5432/zakupki_rag'
python -m pytest tests/test_rag_module.py::TestRAGIntegration -v
```

### Проверка статуса системы

```bash
# Через UI: кнопка "Статус" в секции RAG

# Или через API:
curl http://localhost:8081/ai_rag/status
```

**Ожидаемый ответ:**
```json
{
  "success": true,
  "rag_enabled": true,
  "database_available": true,
  "database_stats": {
    "documents": 5,
    "chunks": 234
  },
  "api_key_configured": true,
  "embeddings_model": "text-embedding-3-small"
}
```

## Troubleshooting

### Проблема: База данных недоступна

**Симптомы:**
- Кнопка "Статус" показывает "✗ БД"
- API возвращает 503

**Решение:**
1. Проверьте, что PostgreSQL запущен: `pg_isready`
2. Проверьте `DATABASE_URL` в `.env`
3. Запустите `python scripts/init_rag_db.py`

### Проблема: Расширение pgvector не установлено

**Симптомы:**
- Ошибка `extension "vector" does not exist`

**Решение Ubuntu/Debian:**
```bash
sudo apt-get install postgresql-16-pgvector
psql -U postgres -d zakupki_rag -c "CREATE EXTENSION vector;"
```

**Решение macOS:**
```bash
brew install pgvector
psql -d zakupki_rag -c "CREATE EXTENSION vector;"
```

### Проблема: API ключ не настроен

**Симптомы:**
- Кнопка "Статус" показывает "✗ API"
- Ошибка при индексации/анализе

**Решение:**
1. Получите API ключ на https://platform.openai.com/api-keys
2. Добавьте в `.env`: `OPENAI_API_KEY=sk-...`
3. Перезапустите приложение

### Проблема: Долгая индексация

**Причины:**
- Большие файлы
- Медленное подключение к OpenAI API

**Решение:**
- Индексируйте файлы небольшими батчами
- Проверьте скорость интернета
- Рассмотрите использование локальной модели эмбеддингов (для будущих версий)

## Производительность

| Операция | Время | Примечание |
|----------|-------|------------|
| Индексация 1 PDF (10 страниц) | 10-15 сек | Зависит от размера |
| Индексация 1 DOCX (50 страниц) | 30-45 сек | Больше текста = дольше |
| Векторный поиск | 1-2 сек | Очень быстро |
| RAG-анализ (Top-K=5) | 10-20 сек | Зависит от модели |
| RAG-анализ (Top-K=10) | 15-30 сек | Больше контекста |

## Стоимость

**Примечание:** Цены OpenAI регулярно меняются. Проверяйте актуальные цены на https://openai.com/pricing

Примерная стоимость для **gpt-4o-mini** (для справки):
- Эмбеддинги: ~$0.00002 / 1K токенов (~$0.02 за 1000 страниц)
- Генерация: ~$0.15 / 1M входных, ~$0.60 / 1M выходных токенов
- Типичный запрос (Top-K=5): ~15K входных + 600 выходных = ~$0.002-0.005

**Совет:** Используйте ручной ввод цен в UI для точного расчёта актуальных затрат.

## Ограничения

1. **Размер контекста**: зависит от модели (128K для gpt-4o-mini)
2. **Язык документов**: русский и английский (основной фокус)
3. **Форматы**: PDF, DOCX, XLSX, TXT, HTML, CSV, TSV, XML, JSON
4. **PostgreSQL**: требуется версия 12+ с pgvector

## Дополнительные материалы

- [Документация приращения 005](../increments_doc/005_increment_2025-10-25.md)
- [Конфигурация моделей](../index/models.json)
- [Тесты](../tests/test_rag_module.py)
- [Скрипт инициализации БД](../scripts/init_rag_db.py)

## Поддержка

При возникновении проблем:
1. Проверьте логи: `logs/app.log`
2. Проверьте статус: кнопка "Статус" в UI
3. Создайте issue в репозитории с описанием проблемы и логами

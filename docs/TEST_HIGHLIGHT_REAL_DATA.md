# Тестирование и исправление подсветки в просмотре индекса

**Дата:** 12 ноября 2025 г.  
**Задача:** Проверить работу подсветки на реальных данных

## Обнаруженные проблемы

### Проблема 1: Удалённые документы в результатах поиска

**Симптом:** При открытии документа из результатов поиска возникала ошибка 404.

**Причина:** 
- `SearchIndexRepository.search()` возвращал документы с `is_soft_deleted = TRUE`
- Эндпоинт `/view/<path>` фильтровал такие документы и возвращал 404
- Пользователь видел документ в результатах поиска, но не мог его открыть

**Решение:**
```python
# Добавлен JOIN с user_documents и фильтрация
SELECT ... 
FROM search_index si
JOIN user_documents ud ON ud.document_id = si.document_id AND ud.user_id = si.user_id
WHERE si.user_id = %s
  AND ud.is_soft_deleted = FALSE  # ← Добавлено
  AND (...)
```

**Файл:** `webapp/db/repositories/search_index_repository.py` (строка 140)

## Тестирование

### Тест 1: Базовая проверка JavaScript (`test_highlight_all_terms.py`)

Проверяет структуру HTML:
- ✅ JavaScript для подсветки присутствует
- ✅ Используется объединённое регулярное выражение
- ✅ Бэкенд не создаёт `<mark>` теги

**Запуск:**
```bash
python3 test_highlight_all_terms.py
```

### Тест 2: Полная проверка на реальных данных (`test_highlight_real_data.py`)

Проверяет полный цикл:
1. **Поиск документов** по терминам (например, `['договор', 'мо']`)
2. **Открытие через `/view/`** с параметром `?q=термин1,термин2`
3. **Анализ HTML:**
   - Наличие JavaScript для подсветки
   - Наличие объединённого regex `/(term1|term2)/gi`
   - Наличие TreeWalker для обхода текстовых узлов
   - Отсутствие бэкенд-подсветки (0 тегов `<mark>` до выполнения JS)
4. **Анализ содержимого:**
   - Подсчёт вхождений каждого термина
   - Вывод контекстов для проверки
5. **Визуальная проверка:**
   - Сохранение HTML в файл для открытия в браузере
   - Проверка подсветки вручную

**Запуск:**
```bash
python3 test_highlight_real_data.py
```

**Результат на реальных данных:**
```
✅ ТЕСТ ПРОЙДЕН
   Все термины присутствуют в документе
   JavaScript подсветки на месте
   Откройте test_highlight_real_data_output.html в браузере
```

**Пример вывода:**
```
Документ: Умный договор товары вер 40 11445932 2025 09 23-14 01.docx
Размер текста: 63812 символов

✅ 'договор': 413 вхождений
   1. ...Проект договора № ________________ Поставка...
   2. ...___________, заключили настоящий Проект договора...

✅ 'мо': 198 вхождений
   1. ...ГО ХОЗЯЙСТВА" ГОРОДСКОГО ОКРУГА СТУПИНО МОСКОВСКОЙ...
   2. ...дной стороны, и ________________, именуемое(ая,ый)...
```

## Как работает подсветка

### Шаг 1: Передача терминов через URL
```
/view/Documents_5666261/document.docx?q=договор,мо
```

### Шаг 2: JavaScript парсит параметр `q`
```javascript
const params = new URLSearchParams(window.location.search);
const q = params.get('q');
const terms = q.split(',').map(t => t.trim()).filter(Boolean);
// terms = ['договор', 'мо']
```

### Шаг 3: Создаётся объединённое регулярное выражение
```javascript
const escapedTerms = terms.map(t => t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
const combinedRegex = new RegExp('(' + escapedTerms.join('|') + ')', 'gi');
// combinedRegex = /(договор|мо)/gi
```

### Шаг 4: Обход текстовых узлов через TreeWalker
```javascript
const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {...});
const nodes = [];
while (walker.nextNode()) nodes.push(walker.currentNode);
```

### Шаг 5: Замена совпадений на `<mark>`
```javascript
nodes.forEach(node => {
    let text = node.nodeValue;
    if (combinedRegex.test(text)) {
        combinedRegex.lastIndex = 0;
        text = text.replace(combinedRegex, function(match) {
            return '<mark class="highlight">' + match + '</mark>';
        });
        // Замена узла
    }
});
```

## Преимущества текущей реализации

1. **Все термины подсвечиваются одновременно** через одно регулярное выражение
2. **Регистронезависимый поиск** (флаг `i` в regex)
3. **Глобальный поиск** всех вхождений (флаг `g`)
4. **Безопасное экранирование** спецсимволов regex
5. **Нет дублирования подсветки** (только фронтенд, без бэкенда)
6. **Исключены удалённые документы** из результатов поиска

## Файлы изменений

1. **`webapp/db/repositories/search_index_repository.py`**:
   - Добавлен JOIN с `user_documents`
   - Фильтрация `is_soft_deleted = FALSE`

2. **`templates/view.html`** (изменён ранее):
   - Объединённое регулярное выражение
   - Правильный сброс `lastIndex`

3. **`webapp/routes/pages.py`** (изменён ранее):
   - Убрана бэкенд-подсветка

4. **`test_highlight_real_data.py`** (новый):
   - Полноценный тест на реальных данных
   - Визуальная проверка

## Коммиты

- `6dd6f6c` - fix: исправлена подсветка всех найденных слов в просмотре индекса
- `708b31c` - fix: исключены удалённые документы из результатов поиска + тест подсветки

## Результат

✅ **Подсветка в просмотре индекса работает корректно:**
- Все найденные слова подсвечиваются жёлтым фоном
- Регистронезависимый поиск
- Нет пропущенных вхождений
- Удалённые документы не появляются в поиске
- Все найденные документы корректно открываются

**Проверено на реальных данных:**
- Документ: 63812 символов
- Термины: 'договор' (413 вхождений), 'мо' (198 вхождений)
- Подсветка работает ✅

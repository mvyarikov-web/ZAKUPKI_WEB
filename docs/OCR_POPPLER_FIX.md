# Исправление: Отсутствие Poppler для конвертации PDF в изображения

## Проблема

При попытке распознавания сканированных PDF-документов через OCR возникала ошибка:

```
PDFInfoNotInstalledError: Unable to get page count. Is poppler installed and in PATH?
```

Библиотека `pdf2image` требует системную утилиту **poppler** для конвертации PDF-страниц в изображения перед OCR-распознаванием. Без этой утилиты модуль OCR не может работать.

## Причина

Poppler не был установлен в системе. Это критическая зависимость для работы OCR, но она не была задокументирована в инструкциях по установке.

## Решение

### 1. Установка Poppler

#### macOS (через Homebrew):
```bash
brew install poppler
```

#### Linux (Ubuntu/Debian):
```bash
sudo apt-get install poppler-utils
```

#### Linux (Fedora/RHEL):
```bash
sudo dnf install poppler-utils
```

### 2. Проверка установки

После установки проверьте, что утилита `pdfinfo` доступна:
```bash
pdfinfo --version
```

### 3. Обновление документации

Обновлён файл `docs/TESSERACT_INSTALL.md` с инструкциями по установке Poppler для всех поддерживаемых платформ.

## Дополнительные улучшения

### Улучшена автокоррекция ориентации

Исходная реализация метода `_auto_orient_image()` имела проблемы:

1. **OSD (Orientation and Script Detection) ошибался**: Tesseract OSD рекомендовал поворот на 270°, но это давало перевёрнутый (нечитаемый) текст.

2. **Неэффективная эвристика**: Первая версия считала "мусорные" символы как "читаемые", что приводило к выбору неправильной ориентации.

### Новый алгоритм оценки качества ориентации

```python
# Вычисляем оценку качества:
# - Длина текста (больше = лучше)
# - Доля кириллических/латинских символов (игнорируя "мусор")
# - Наличие пробелов (признак разделённых слов)

cyrillic_latin = sum(1 for c in text if ('\u0400' <= c <= '\u04FF' or 'a' <= c.lower() <= 'z'))
digits = sum(1 for c in text if c.isdigit())
spaces = sum(1 for c in text if c == ' ')

useful = cyrillic_latin + digits + spaces
useful_ratio = useful / total_chars

letter_ratio = cyrillic_latin / total_chars

# Итоговая оценка: длина * доля_полезных * доля_букв
score = total_chars * useful_ratio * letter_ratio
```

Теперь алгоритм:
- Игнорирует "мусорные" символы (не кириллица/латиница)
- Штрафует за отсутствие букв
- Корректно выбирает правильную ориентацию

### Результаты тестирования

Для документа `ТЗ поставка сплит-систем.pdf`:

| Ориентация | Старая оценка | Новая оценка | Качество текста |
|------------|---------------|--------------|-----------------|
| 0°         | 854.0         | 350.1        | Мусор           |
| **90°**    | 948.0         | **736.7**    | ✅ Правильно    |
| 180°       | 955.0         | 368.6        | Мусор           |
| 270°       | 918.0         | 637.3        | Мусор           |

✅ Теперь правильная ориентация (90°) получает максимальную оценку.

## Пример использования

```python
from document_processor.pdf_reader import PdfReader

reader = PdfReader()
result = reader.read_pdf(
    'scan.pdf',
    ocr='auto',           # автоматическое определение скана
    lang='rus+eng',       # русский + английский
    max_pages_ocr=10      # максимум страниц для OCR
)

print(f"Извлечено текста: {len(result['text'])} символов")
print(f"OCR использовался: {result['ocr_used']}")
print(result['text'])
```

## Файлы, затронутые изменениями

- `document_processor/pdf_reader/reader.py` — улучшен метод `_auto_orient_image()`
- `docs/TESSERACT_INSTALL.md` — добавлены инструкции по установке Poppler
- `docs/OCR_POPPLER_FIX.md` — описание проблемы и решения (этот файл)

## Зависимости

Для работы OCR требуются:

### Системные пакеты:
- **tesseract** — движок OCR
- **tesseract-lang** — языковые пакеты (rus, eng)
- **poppler** — конвертация PDF в изображения

### Python-библиотеки:
- `pytesseract` — обёртка для Tesseract
- `pdf2image` — конвертация PDF в изображения
- `Pillow` — обработка изображений

## Дата исправления

18 октября 2025 г.

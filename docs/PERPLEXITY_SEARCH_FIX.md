# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ–±-–ø–æ–∏—Å–∫–∞ Perplexity Sonar

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –º–æ–¥–µ–ª–µ–π Perplexity Sonar —Å –≤–∫–ª—é—á—ë–Ω–Ω–æ–π –≥–∞–ª–∫–æ–π "Search" –≤–µ–±-–ø–æ–∏—Å–∫ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è. –ú–æ–¥–µ–ª—å –æ—Ç–≤–µ—á–∞–ª–∞ —Ñ—Ä–∞–∑–∞–º–∏ –≤—Ä–æ–¥–µ "–Ø –Ω–µ –º–æ–≥—É –∑–∞–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç—ã..." –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–Ω–∞–Ω–∏—è.

### –ü—Ä–∏—á–∏–Ω–∞

OpenAI SDK –≤–µ—Ä—Å–∏–∏ 1.x –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ `extra_json`, –Ω–æ **–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∏—Ö** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º API. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ Perplexity (`enable_search_classifier`, `search_mode`, `web_search_options` –∏ –¥—Ä.) –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è **—è–≤–Ω–æ —á–µ—Ä–µ–∑ `extra_body`**, –∏–Ω–∞—á–µ –æ–Ω–∏ —Ç–µ—Ä—è—é—Ç—Å—è.

## –†–µ—à–µ–Ω–∏–µ

### 1. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ —á–µ—Ä–µ–∑ `extra_body`

**–ë—ã–ª–æ:**
```python
request_params["enable_search_classifier"] = True
request_params["search_mode"] = "web"
# ... –∏ —Ç.–¥.
```

**–°—Ç–∞–ª–æ:**
```python
request_params["extra_body"] = {
    "enable_search_classifier": True,
    "search_mode": "web",
    "language_preference": "ru",
    "web_search_options": {"search_context_size": "low"},
    # ... –∏ –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞
}
```

### 2. –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ —á–µ—Ä–µ–∑ `extra_body`

**–ë—ã–ª–æ:**
```python
request_params['disable_search'] = True
```

**–°—Ç–∞–ª–æ:**
```python
request_params['extra_body'] = {'disable_search': True}
```

### 3. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
- `usage.num_search_queries` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- `usage.search_context_size` ‚Äî –æ–±—ä—ë–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –≤–µ–±-–∫–æ–Ω—Ç–µ–Ω—Ç–∞
- `search_results[]` ‚Äî —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å URL –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏

## –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã

1. `webapp/services/search/manager.py` ‚Äî —Ñ—É–Ω–∫—Ü–∏—è `apply_search_to_request()` —Ç–µ–ø–µ—Ä—å —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç `extra_body`
2. `webapp/services/rag_service.py` ‚Äî RAG-–∞–Ω–∞–ª–∏–∑ —Å –ø–æ–∏—Å–∫–æ–º, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ search usage
3. `webapp/routes/ai_rag.py` ‚Äî –ø—Ä—è–º–æ–π –∞–Ω–∞–ª–∏–∑ –±–µ–∑ RAG, —Ç—Ä–∏ –±–ª–æ–∫–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π + 2 retry)

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å–∏:

**–° –≤–∫–ª—é—á—ë–Ω–Ω—ã–º –ø–æ–∏—Å–∫–æ–º:**
```
üåê –†–µ–∂–∏–º –° –ü–û–ò–°–ö–û–ú: extra_body = {'enable_search_classifier': True, 'search_mode': 'web', ...}
üîç Search usage: num_search_queries=3, search_context_size=1234
‚úÖ –ü–æ–∏—Å–∫ –ë–´–õ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω
üîó –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–æ–∏—Å–∫–∞ (3 –≤—Å–µ–≥–æ): Example Title (https://example.com); ...
```

**–ë–µ–∑ –ø–æ–∏—Å–∫–∞:**
```
üö´ –†–µ–∂–∏–º –ë–ï–ó –ü–û–ò–°–ö–ê: extra_body = {'disable_search': True}
üìù –ü–æ–∏—Å–∫ –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω (—Ç–æ–ª—å–∫–æ –∑–Ω–∞–Ω–∏—è –º–æ–¥–µ–ª–∏)
```

### –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å

1. –í—ã–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å `sonar` –∏–ª–∏ `sonar-pro`
2. –í–∫–ª—é—á–∏—Ç—å –≥–∞–ª–∫—É "Search"
3. –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å, —Ç—Ä–µ–±—É—é—â–∏–π –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ `search_results`

## –°–ø—Ä–∞–≤–∫–∞ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º Perplexity

–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–≤—Å–µ —á–µ—Ä–µ–∑ `extra_body`):

- `enable_search_classifier` (bool) ‚Äî —É–º–Ω—ã–π —Ä–µ–∂–∏–º, –º–æ–¥–µ–ª—å —Å–∞–º–∞ —Ä–µ—à–∞–µ—Ç, –Ω—É–∂–µ–Ω –ª–∏ –ø–æ–∏—Å–∫
- `disable_search` (bool) ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞
- `search_mode` (string) ‚Äî —Ä–µ–∂–∏–º: `"web"`, `"academic"`, `"sec"`
- `search_domain_filter` (array) ‚Äî —Å–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞
- `search_recency_filter` (string) ‚Äî `"day"`, `"week"`, `"month"`, `"year"`
- `web_search_options.search_context_size` (string) ‚Äî `"low"`, `"medium"`, `"high"`
- `language_preference` (string) ‚Äî `"ru"`, `"en"`, –∏ –¥—Ä.
- `max_results` (int) ‚Äî –º–∞–∫—Å–∏–º—É–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞

–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: https://docs.perplexity.ai/api-reference/chat-completions-post

## –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

2 –Ω–æ—è–±—Ä—è 2025 –≥.

–ö–æ–º–º–∏—Ç: —Å–º. `git log --oneline -1`

<!-- Use this file to provide workspace-specific custom instructions to Copilot. For more details, visit https://code.visualstudio.com/docs/copilot/copilot-customization#_use-a-githubcopilotinstructionsmd-file -->
- [x] Verify that the copilot-instructions.md file in the .github directory is created.

- [ ] Clarify Project Requirements
	<!-- Ask for project type, language, and frameworks if not specified. Skip if already provided. -->

- [ ] Scaffold the Project
	<!--
	Ensure that the previous step has been marked as completed.
	Call project setup tool with projectType parameter.
	Run scaffolding command to create project files and folders.
	Use '.' as the working directory.
	If no appropriate projectType is available, search documentation using available tools.
	Otherwise, create the project structure manually using available file creation tools.
	-->

- [ ] Customize the Project
	<!--
	Verify that all previous steps have been completed successfully and you have marked the step as completed.
	Develop a plan to modify codebase according to user requirements.
	Apply modifications using appropriate tools and user-provided references.
	Skip this step for "Hello World" projects.
	-->

- [ ] Install Required Extensions
	<!-- ONLY install extensions provided mentioned in the get_project_setup_info. Skip this step otherwise and mark as completed. -->

- [ ] Compile the Project
	<!--
	Verify that all previous steps have been completed.
	Install any missing dependencies.
	Run diagnostics and resolve any issues.
	Check for markdown files in project folder for relevant instructions on how to do this.
	-->

- [ ] Create and Run Task
	<!--
	Verify that all previous steps have been completed.
	Check https://code.visualstudio.com/docs/debugtest/tasks to determine if the project needs a task. If so, use the create_and_run_task to create and launch a task based on package.json, README.md, and project structure.
	Skip this step otherwise.
	 -->

- [ ] Launch the Project
	<!--
	Verify that all previous steps have been completed.
	Prompt user for debug mode, launch only if confirmed.
	 -->

instructions

# Инструкции для GitHub Copilot — проект ZAKUPKI_WEB

Этот репозиторий — веб-интерфейс (Flask) для автоматизированного поиска по документам с полнотекстовым поиском через PostgreSQL. Поддержка вложенных папок, ZIP/RAR и базового OCR.

## Локализация

Вся документация, интерфейс, сообщения об ошибках, шаблоны и справка должны быть на русском языке. README.md, инструкции, комментарии и тестовые сообщения — только на русском. Исключение: имена переменных, функций и классов — на английском (PEP8).

## Короткая шпаргалка (для Copilot)
- Пиши ответы и комментарии на русском языке.
- Генерируй минимум: сначала контекст и микроплан, затем точечный дифф (без форматирования всего файла).
- Сокращай контекст: читай/редактируй только релевантные блоки; не дублируй неизменившееся.
- Сначала тест(ы), потом код: контракт в 2–4 bullets + 1–2 минимальных теста → реализация до «зелёного».
- Не добавляй лишних зависимостей; переиспользуй паттерны проекта.
- Тяжёлые операции (OCR/RAR) — в индексации, не в HTTP; при отсутствии системных deps — graceful degrade.
- Поиск через PostgreSQL full-text search (таблица search_index с tsvector и GIN-индексом).

## Контекст проекта
- Языки/стек: Python 3.9+, Flask, SQLAlchemy, PostgreSQL, Jinja2, JavaScript (vanilla), HTML/CSS.
- Бэкенд: `app.py` — роуты загрузки, удаления, поиска; интеграция с БД через репозитории.
- Поиск: через PostgreSQL full-text search (таблица `search_index`, триггер для автоматической индексации).
- Модули БД: `webapp/db/`
	- `models.py` — SQLAlchemy модели (User, Document, Chunk, SearchIndex и др.).
	- `repositories/` — репозитории для работы с БД (DocumentRepository, SearchIndexRepository и др.).
	- `base.py` — настройка engine, SessionLocal, Base.
- Тесты: `pytest`, каталог `tests/`.
- Документация: `docs/Постановка_модуль_обработки_файлов.md`, `docs/Автотесты_модуль_обработки_файлов.md`.

## Общие принципы для генерации кода
- **МИНИМАЛЬНЫЕ ИЗМЕНЕНИЯ**: Всегда делай минимальные изменения с максимальным сохранением уже разработанного функционала. Не переписывай рабочий код без крайней необходимости.
- Пиши код на Python и JS аккуратно, с приоритетом на простоту, читаемость и устойчивость к ошибкам.
- Пиши ответы и документацию на русском языке (кроме имён сущностей в коде).
- Сообщения/интерфейс — на русском; имена переменных/классов/функций — на английском.
- Соблюдай PEP 8, используй type hints, инициализируй понятные докстринги (Google/Numpy style).
- Не вноси массовое форматирование/рефакторинг без необходимости. В патчах меняй минимум строк.
- Для путей всегда используй `os.path.join`, не допускай обходов директории (`..`), проверяй существование путей.
- Все операции с файлами — в кодировке UTF-8 (при чтении произвольных TXT — пробуй chardet с фолбэками cp1251/cp866/latin-1).

## Практики для индексации и поиска
- Индексация: вызывай `build_db_index(db, owner_id, folder_path)` из `webapp.services.db_indexing`.
- Поиск: используй `SearchIndexRepository.search(user_id, keywords)` для полнотекстового поиска через PostgreSQL.
- Автоматический триггер `search_index_tsvector_trigger()` обновляет поле `search_vector` при INSERT/UPDATE в таблице `search_index`.
- OCR и RAR — опциональны: оборачивай импорты и вызовы в try/except, gracefully degrade, логируй, но не падай.
- Архивы: извлекай поддерживаемые файлы во временные, индексируй с виртуальным источником `zip://...` или `rar://...`.
- Не запускай дорогостоящую обработку в HTTP-запросах помимо `/build_index`. Поиск — мгновенный на готовом индексе БД.

## Веб-слой (Flask)
- **Структура папок**: 
	- `uploads/` — только загружаемые поддерживаемые файлы пользователей
	- `index/` — технические файлы: `status.json`, `search_results.json`, логи
	- Неподдерживаемые файлы не копируются в `uploads/`, но отображаются в UI с серой заливкой
- Роуты:
	- POST `/upload` — сохраняй в `uploads/` только поддерживаемые файлы с безопасными именами; поддерживай вложенные папки через webkitdirectory.
	- POST `/build_index` — явно пересобирай индекс для `uploads/`, записывай в БД (`documents`, `chunks`, `search_index`).
	- POST `/search` — используй `SearchIndexRepository` для поиска по БД с фолбэком на `chunks`.
	- DELETE `/delete/<path>` и `/delete_folder/<path>` — защищайся от traversal.
	- GET `/result/<path>` — показывай статусы и сниппеты из БД.
	- GET `/download/<path>` — отдача файлов из `uploads/` с проверкой безопасного пути.
	- GET `/files_json` — дерево файлов/папок под `uploads/` в JSON для UI.
	- GET `/health` — быстрая проверка работоспособности (200 OK, JSON).
	- GET `/index_status` — статус индексации из БД (количество документов, чанков).
- Шаблоны/статик: правки UI делай в `templates/*.html` и `static/js/script.js`. Не добавляй фреймворки без необходимости.
 - JSON: выставляй `app.config['JSON_AS_ASCII'] = False` для корректной кириллицы.
 - Ограничение загрузок: обрабатывай `413 Request Entity Too Large` (см. `MAX_CONTENT_LENGTH`), возвращай дружелюбное сообщение.


## Тестирование
- Фреймворк: `pytest`. Располагай тесты в `tests/`.
- Стратегия:
	- Сначала минимальные тесты (happy path), затем углы (архивы, OCR, кодировки, вложенные папки, повреждённые файлы).
	- Используй временные каталоги `tmp_path` и фикстуры для генерации входных данных.
	- Помечай `@pytest.mark.skipif` тесты, требующие Tesseract/`unrar`.
	- Проверяй, что данные корректно записываются в БД (`documents`, `chunks`, `search_index`), поиск выдаёт корректные сниппеты.
- Запуск: `pytest -q` или `PYTHONPATH=. pytest tests/`.
 - По умолчанию держи минимальный набор тестов (базовый индексатор и поисковик); тяжёлые/длинные сценарии исключай из дефолтного прогона через `pytest.ini` и пометки `skip`.

## Безопасность и надёжность
- Не доверяй пользовательским путям и именам: нормализуй, фильтруй, защищайся от `..` и абсолютных путей.
- Ограничивай размер загружаемых файлов `MAX_CONTENT_LENGTH`.
- При ошибках внешних библиотек — не падай, логируй и продолжай обработку следующих файлов.
- Очищай временные файлы после индексации архивов.
 - Для удаления/скачивания используй проверку безопасного пути, например `_is_safe_subpath(base, target)`: цель должна лежать внутри базы (`uploads/`), иначе отвечай 400 и логируй попытку.
 - Валидация запросов поиска: лимитируй количество и длину терминов (например, до 10 штук, длина 1–64), удаляй дубликаты, нормализуй пробелы; пустые/некорректные запросы — 400.
 - Всегда возвращай JSON в UTF-8 (см. `JSON_AS_ASCII=False`), сообщения об ошибках — краткие и понятные.
 - Обработчик `413 Request Entity Too Large`: не падай стеком, возвращай аккуратный JSON/HTML ответ и логируй размер.

## Производительность
- Избегай лишних повторных чтений файлов. Предпочитай прединдексирование и поиск по БД с использованием индексов (GIN для tsvector).
- PostgreSQL full-text search обеспечивает быструю индексацию и поиск.
- Для будущего: кэш по mtime/хэшу, ограничение глубины обхода, лайтовый OCR.

## Оптимизация использования нейросетей (минимум затрат без потери качества)
- Решай локально и порционно: прежде чем звать ИИ, попробуй стандартные инструменты (поиск по коду, grep, локальные тесты/линтеры). Генерируй только то, что нельзя получить простыми средствами.
- Держи изменения минимальными: сначала короткий контекст и микроплан (2–4 пункта), затем точечные правки. Не переписывай файлы целиком, генерируй минимальные диффы.
- Сокращай объём токенов:
	- Читай файлы крупными, релевантными блоками, а не весь репозиторий; не выводи содержимое файлов, если можно сослаться на путь/фрагмент.
	- Пиши кратко, без лишнего форматирования и повторов. Не дублируй неизменившиеся разделы между итерациями (сообщай только дельту).
	- Для примеров используй минимальные, самодостаточные фрагменты.
- Переиспользуй код и паттерны проекта: опирайся на стандартную библиотеку и уже добавленные зависимости; не вводи новые библиотеки без веской причины.
- Детерминизм вместо «магии»: сначала контракт/интерфейс и 1–2 минимальных теста, затем реализация до «зелёного». Это снижает количество итераций с ИИ.
- Тяжёлые операции — только там, где нужно:
	- OCR и разбор RAR — выполняй в фазе индексации или по явному запросу; не запускай их внутри HTTP-ручек.
	- При отсутствии системных зависимостей (tesseract/unrar) — gracefully degrade: логируй и пропускай, без повторных попыток.
- Избегай повторной работы: кэшируй результаты (индекс по mtime/хэшу), не перечитывай файлы без необходимости, переиспользуй временные артефакты.
- Документация и ответы: ссылайся на существующие спецификации в `docs/`, не пересказывай их целиком. Описывай только новые/изменённые шаги.
- Недостающие детали — делай 1–2 разумные предпосылки согласно конвенциям репозитория и двигайся дальше; вопросы задавай только если это блокирует прогресс.

## Зависимости
- Обязательные: Flask, SQLAlchemy, psycopg2-binary, alembic, python-docx, openpyxl, pypdf, pdfplumber, chardet.
- Опциональные: pytesseract, Pillow, pdf2image, rarfile (системные: tesseract, unrar).
- Фиксируй зависимости в `requirements.txt`. Не добавляй тяжёлые зависимости без весомых причин.

## Коммиты и PR
- Сообщения на русском, стиль приблизительно Conventional Commits:
	- `feat: добавлен эндпоинт /build_index`
	- `fix: поиск игнорирует заголовки в индексе`
	- `test: добавлены тесты для zip-архивов`
	- `docs: обновлены инструкции для Copilot`
- В PR указывай:
	- цель изменения, затронутые файлы/модули;
	- риски/ограничения; 
	- как проверить (шаги запуска/тесты).

## Как предлагать изменения Copilot'ом
- Предлагай точечные изменения: минимум диффов, без «форматировать весь файл».
- Если изменение неочевидно — сначала подсвети контекст и предложи микроплан (2–4 пункта), затем код.
- После изменения публичного поведения — добавь/обнови тесты.
- Учитывай текущую структуру проекта и ранее принятые решения (БД вместо файлов, PostgreSQL full-text search, OCR optional).

## Быстрые рецепты
- Создать индекс для uploads:
	- Бэкенд: `build_db_index(db, owner_id, 'uploads')`
	- UI: POST `/build_index` (кнопка «Построить индекс» уже есть).
- Поиск по словам `['жираф', 'лес']`:
	- Используй `SearchIndexRepository.search(user_id, ['жираф','лес'], limit=100)`
	- Или через эндпоинт: POST `/search` с `{"keywords": ["жираф", "лес"]}`
- Добавление нового формата:
	- В `db_indexing.py` — новый ветвитель по расширению, извлечение текста, нормализация, метаданные.
	- Тесты на извлечение и поиск по БД.

## Dev-сервер: порт и перезапуск (macOS/zsh)
- Приложение по умолчанию слушает на порту 8081. Перед перезапуском сервера освобождай порт, если он занят.

## Безопасность и надёжность
- Не доверяй пользовательским путям и именам: нормализуй, фильтруй, защищайся от `..` и абсолютных путей.
- Ограничивай размер загружаемых файлов `MAX_CONTENT_LENGTH`.
- При ошибках внешних библиотек — не падай, логируй и продолжай обработку следующих файлов.
- Очищай временные файлы после индексации архивов.
 - Для удаления/скачивания используй проверку безопасного пути, например `_is_safe_subpath(base, target)`: цель должна лежать внутри базы (`uploads/`), иначе отвечай 400 и логируй попытку.
 - Валидация запросов поиска: лимитируй количество и длину терминов (например, до 10 штук, длина 1–64), удаляй дубликаты, нормализуй пробелы; пустые/некорректные запросы — 400.
 - Всегда возвращай JSON в UTF-8 (см. `JSON_AS_ASCII=False`), сообщения об ошибках — краткие и понятные.
 - Обработчик `413 Request Entity Too Large`: не падай стеком, возвращай аккуратный JSON/HTML ответ и логируй размер.

## Производительность
- Избегай лишних повторных чтений файлов. Предпочитай прединдексирование и поиск по одному файлу.
- Для будущего: кэш по mtime/хэшу, ограничение глубины обхода, лайтовый OCR.

## Оптимизация использования нейросетей (минимум затрат без потери качества)
- Решай локально и порционно: прежде чем звать ИИ, попробуй стандартные инструменты (поиск по коду, grep, локальные тесты/линтеры). Генерируй только то, что нельзя получить простыми средствами.
- Держи изменения минимальными: сначала короткий контекст и микроплан (2–4 пункта), затем точечные правки. Не переписывай файлы целиком, генерируй минимальные диффы.
- Сокращай объём токенов:
	- Читай файлы крупными, релевантными блоками, а не весь репозиторий; не выводи содержимое файлов, если можно сослаться на путь/фрагмент.
	- Пиши кратко, без лишнего форматирования и повторов. Не дублируй неизменившиеся разделы между итерациями (сообщай только дельту).
	- Для примеров используй минимальные, самодостаточные фрагменты.
- Переиспользуй код и паттерны проекта: опирайся на стандартную библиотеку и уже добавленные зависимости; не вводи новые библиотеки без веской причины.
- Детерминизм вместо «магии»: сначала контракт/интерфейс и 1–2 минимальных теста, затем реализация до «зелёного». Это снижает количество итераций с ИИ.
- Тяжёлые операции — только там, где нужно:
	- OCR и разбор RAR — выполняй в фазе индексации или по явному запросу; не запускай их внутри HTTP-ручек.
	- При отсутствии системных зависимостей (tesseract/unrar) — gracefully degrade: логируй и пропускай, без повторных попыток.
- Избегай повторной работы: кэшируй результаты (индекс по mtime/хэшу), не перечитывай файлы без необходимости, переиспользуй временные артефакты.
- Документация и ответы: ссылайся на существующие спецификации в `docs/`, не пересказывай их целиком. Описывай только новые/изменённые шаги.
- Недостающие детали — делай 1–2 разумные предпосылки согласно конвенциям репозитория и двигайся дальше; вопросы задавай только если это блокирует прогресс.

## Зависимости
- Обязательные: Flask, python-docx, openpyxl, pypdf, pdfplumber, chardet.
- Опциональные: pytesseract, Pillow, pdf2image, rarfile (системные: tesseract, unrar).
- Фиксируй зависимости в `requirements.txt`. Не добавляй тяжёлые зависимости без весомых причин.

## Коммиты и PR
- Сообщения на русском, стиль приблизительно Conventional Commits:
	- `feat: добавлен эндпоинт /build_index`
	- `fix: поиск игнорирует заголовки в индексе`
	- `test: добавлены тесты для zip-архивов`
	- `docs: обновлены инструкции для Copilot`
- В PR указывай:
	- цель изменения, затронутые файлы/модули;
	- риски/ограничения; 
	- как проверить (шаги запуска/тесты).

## Как предлагать изменения Copilot’ом
- Предлагай точечные изменения: минимум диффов, без «форматировать весь файл».
- Если изменение неочевидно — сначала подсвети контекст и предложи микроплан (2–4 пункта), затем код.
- После изменения публичного поведения — добавь/обнови тесты.
- Учитывай текущую структуру проекта и ранее принятые решения (индекс, игнор заголовков, OCR optional).

## Быстрые рецепты
- Создать индекс для uploads:
	- Бэкенд: `DocumentProcessor().create_search_index('uploads')`
	- UI: POST `/build_index` (кнопка «Построить индекс» уже есть).
- Поиск по словам `['жираф', 'лес']`:
	- Путь к индексу: `uploads/_search_index.txt`
	- `Searcher().search(index_path, ['жираф','лес'], context=80)`
- Добавление нового формата:
	- В `indexer.py` — новый ветвитель по расширению, извлечение текста, нормализация, метаданные.
	- Тесты на извлечение и поиск по индексу.

## Dev-сервер: порт и перезапуск (macOS/zsh)
- Приложение по умолчанию слушает на порту 5000. Перед перезапуском сервера освобождай порт, если он занят.
- Команды (macOS, zsh):
	- Освободить порт 5000:
		- `lsof -ti:5000 | xargs kill -9`
	- Дополнительно, если используется 8080/8081:
		- `lsof -ti:8080 | xargs kill -9`
		- `lsof -ti:8081 | xargs kill -9`
- Порядок действий для запуска из рабочей папки:
	1) Освободить порт(ы) по необходимости (см. выше).
	2) Запустить сервер: `python3 app.py` (или через виртуальную среду: `.venv/bin/python app.py`).
- Предпочитай мягкое завершение процессов, а принудительное (`-9`) используй только если обычное не сработало. Для точечного завершения можно применять: `pkill -f "python.*app.py"`.

## Логирование и контроль
- Центральный лог приложения: `logs/app.log` (создаётся автоматически). Формат: время, уровень, модуль:строка, сообщение.
- Ротация логов: ежедневная (полночь), хранить 7 архивов. Код использует `TimedRotatingFileHandler` с UTF-8.
- Логируются ключевые события: загрузка/удаление файлов и папок, сборка индекса, поиск (термины, кол-во совпадений/групп), ошибки с трейсбэком, HTTP-запросы с временем обработки.
- Уровни логов: INFO по умолчанию; DEBUG используется точечно для подробностей. Логи `werkzeug` заглушены до WARNING.
- Периодическая очистка логов обеспечивается ротацией; при необходимости можно увеличить/уменьшить `backupCount`.
- При добавлении нового функционала — логируй начало/конец операции и ошибки (через `app.logger.info/debug/exception`). Не засоряй логи лишним шумом.
 - Единый лог для всех модулей: обработчик подключён к корневому логгеру, поэтому `document_processor` и прочие модули пишут в тот же `logs/app.log` без отдельной настройки.

## Что не делать
- Не выполнять поиск по исходным файлам в HTTP-ручке — только по индексу.
- Не падать на отсутствующих системных зависимостях (OCR/RAR) — пропускать с логом.
- Не смешивать логику UI и индексации: UI в шаблонах/JS, индексация в `document_processor`.
# Инкремент 9: Расширение логики поиска и управление состоянием папок/архивов

## Постановка
1. **Не сворачивать архивы и папки автоматически:**
   - Архивы и папки должны оставаться развернутыми после открытия или выполнения поиска, если они не были свернуты вручную.
   - Если архив или папка были свернуты вручную, их состояние должно запоминаться и восстанавливаться при обновлении страницы или выполнении поиска.

2. **Добавить переключатель "Содержит/Не содержит" в строку поиска:**
   - Если переключатель установлен в состояние "Содержит", логика поиска остается неизменной.
   - Если переключатель установлен в состояние "Не содержит":
     - Зеленым светофором помечаются файлы, которые **не содержат** слова поиска.
     - В результатах отображается слово с префиксом "не содержит" (например, "не содержит: договор").
     - Слово "не содержит" перед словом поиска должно быть выделено красным цветом
     - В превью выводится аналогичное количество текста с начала документа, как и в текущей реализации, но только один сниппет.
     - Визуализация и сортировка остаются такими же: файлы, соответствующие критерию "не содержит", выводятся в начале, остальные — в конце.

## Спецификация
### 1. Управление состоянием папок и архивов
- **Frontend:**
  - Добавить обработку состояния папок и архивов в localStorage.
  - При загрузке страницы или обновлении списка файлов восстанавливать состояние (развернуто/свернуто) из localStorage.
  - При ручном сворачивании/разворачивании обновлять состояние в localStorage.

- **Backend:**
  - Изменений не требуется.

### 2. Переключатель "Содержит/Не содержит"
- **Frontend:**
  - Добавить переключатель (toggle) в строку поиска.
  - При изменении состояния переключателя обновлять параметр запроса к API.
  - Обновить визуализацию результатов:
    - Добавить префикс "не содержит" к словам поиска в результатах.
    - Ограничить количество сниппетов до одного для режима "Не содержит".

- **Backend:**
  - Расширить API поиска:
    - Добавить параметр `exclude_mode` (булево значение).
    - Если `exclude_mode=True`, фильтровать файлы, которые **не содержат** слова поиска.
    - Возвращать результаты с пометкой "не содержит".

## Реализация (простыми словами)
1. **Frontend:**
   - Добавить переключатель "Содержит/Не содержит" в HTML-шаблон.
   - Обновить JavaScript для обработки переключателя и обновления параметров поиска.
   - Реализовать сохранение состояния папок/архивов в localStorage.

2. **Backend:**
   - Обновить метод поиска в `Searcher` для обработки параметра `exclude_mode`.
   - Добавить фильтрацию файлов, которые не содержат слова поиска.

## Примечания
- Все изменения должны быть покрыты автотестами.
- Убедиться, что новый функционал не ломает существующую логику поиска и отображения.
- Слово "не содержит" перед словом поиска должно быть выделено красным цветом.

## Фактическая реализация

### Дата и время пуша (MSK)
2025-01-10 00:09 MSK

### Git commit hash
f182508

### Backend изменения
1. **document_processor/search/searcher.py:**
   - Добавлен параметр `exclude_mode=False` в метод `search()`
   - Реализована логика исключающего поиска: файлы НЕ содержащие ни одного из ключевых слов
   - В exclude_mode сниппет берётся с начала документа (первые `context` символов)
   - Результаты помечаются флагом `exclude_mode=True`

2. **webapp/routes/search.py:**
   - Добавлена обработка параметра `exclude_mode` из JSON-запроса
   - Обновлена функция `_search_in_files()` для передачи `exclude_mode` в Searcher
   - Результаты группируются с учётом режима исключения
   - Для exclude_mode формируется префикс "не содержит: <термин>" для каждого ключевого слова
   - Ограничение сниппетов до 1 в режиме исключения

### Frontend изменения
1. **templates/index.html:**
   - Добавлен toggle-переключатель в контейнер поиска
   - Структура: checkbox внутри label с классом `toggle-switch`
   - Label с id `toggleLabel` для динамического обновления текста

2. **static/css/styles.css:**
   - Стили для `.search-mode-toggle` и `.toggle-switch`
   - Зелёный цвет (#2ecc71) для состояния "Содержит"
   - Красный цвет (#e74c3c) для состояния "Не содержит"
   - Стили для `.exclude-prefix` (красный текст, жирный шрифт)

3. **static/js/script.js:**
   - Добавлены константы `excludeModeToggle` и `toggleLabel`
   - Обработчик события `change` для переключателя (обновляет label)
   - Функция `performSearch()` передаёт `exclude_mode` в API
   - Обработка результатов с префиксом "не содержит:" - выделение красным
   - Ограничение сниппетов до 1 в exclude mode
   - Сохранение состояния архивов в localStorage через `data-path` атрибут
   - Восстановление состояния архивов при загрузке страницы

### Тесты
1. **tests/test_exclude_mode.py** (5 тестов):
   - `test_exclude_mode_basic` - базовый режим исключения
   - `test_exclude_mode_multiple_keywords` - несколько ключевых слов
   - `test_exclude_mode_snippet_from_start` - сниппет с начала документа
   - `test_normal_mode_still_works` - обычный режим не сломан
   - `test_exclude_mode_empty_result` - пустой результат когда все файлы содержат термин

2. **tests/test_flask_exclude_mode.py** (4 теста):
   - `test_search_with_exclude_mode_true` - API с exclude_mode=True
   - `test_search_with_exclude_mode_false` - API с exclude_mode=False
   - `test_search_without_exclude_mode_parameter` - без параметра (по умолчанию False)
   - `test_search_exclude_mode_with_prefix` - проверка префикса "не содержит:"

### Логика работы
- **Обычный режим (Содержит)**: ищутся файлы, содержащие хотя бы одно ключевое слово. До 2 сниппетов на термин. Зелёный статус для найденных.
- **Режим исключения (Не содержит)**: ищутся файлы, НЕ содержащие ни одного из ключевых слов. 1 сниппет с начала документа. Зелёный статус для файлов без ключевых слов.
- **localStorage**: Состояния папок и архивов сохраняются при сворачивании/разворачивании и восстанавливаются при перезагрузке.
- **Совместимость**: Все изменения обратно совместимы, параметр `exclude_mode` опционален (по умолчанию False).
# Постановка

Сформировать инкремент 18 с подробным планом ручного сквозного тестирования веб-интерфейса на актуальных данных. План должен использоваться как чек-лист: каждый шаг помечается как пройденный после визуального подтверждения пользователем.

# Спецификация

## Общие условия
- [ ] Использовать существующего администратора (user_id = 5).
- [ ] Работать с уже загруженными документами в `uploads/`.
- [ ] Не выполнять сценарий авторизации (сессия должна быть активной или использовать прямой доступ).
- [ ] Фиксировать скриншоты или текстовое подтверждение для каждого шага.

## Шаги проверки

### 1. Проверка окружения
- [ ] Убедиться, что сервер отвечает (GET `/health` → 200).
- [ ] Открыть главную страницу и зафиксировать состояние панели инструментов (кнопки «Перестроить индекс» и «Просмотр индекса»).

### 2. Список файлов и статусы
- [ ] Развернуть несколько папок, убедиться в корректной структуре дерева.
- [ ] Проверить отображение счётчиков, статусов и ошибок для проблемных файлов.

### 3. Построение индекса
- [ ] Запустить «Построить индекс» и дождаться завершения прогресса.
- [ ] Проверить обновление `index_status` и отсутствие ошибок в логах.

### 4. Перестроение индекса
- [ ] Запустить «Перестроить индекс», убедиться в блокировке кнопки и уведомлениях.
- [ ] Проверить переиндексацию документов с нулевым количеством символов/ошибками.
- [ ] Убедиться в обновлении `folder_index_status.root_hash`.

### 5. Поиск
- [ ] Выполнить поиск по термину с ожидаемыми совпадениями, проверить сниппеты и подсветку.
- [ ] Выполнить поиск по отсутствующему термину, убедиться в корректном ответе.
- [ ] Проверить режим исключающего поиска (если активен).
- [ ] Очистить поиск и подтвердить исчезновение подсветки.

### 6. Просмотр индекса
- [ ] Открыть «Просмотр индекса» без параметров, убедиться в корректной верстке и отсутствии плейсхолдеров.
- [ ] Открыть с параметром `q=` и проверить, что подсветка `<mark>` появляется только в этом режиме.

### 7. Проверка документов
- [ ] Открыть несколько документов из списка/результатов, убедиться в корректной подсветке.
- [ ] Проверить fallback-сообщение для PDF с пустым извлечением.
- [ ] Выполнить скачивание файла и убедиться в безопасном пути.

### 8. Администрирование
- [ ] Зайти в админ-панель и проверить кнопку «Назад» (history.back()).
- [ ] Убедиться, что в профиле обычного пользователя отсутствует «Очистка БД».
- [ ] Выполнить очистку в админке (при допустимости), проверить отсутствие ошибок и обновление UI.
- [ ] После очистки убедиться, что поиск и индекс становятся пустыми.

### 9. Логи и телеметрия
- [ ] Просмотреть `logs/app.log` на наличие ошибок во время теста.
- [ ] Проверить файлы `index/status.json`, `index/search_results.json` (если используются) на консистентность.

### 10. Итоговый отчёт
- [ ] Собрать скриншоты и логи по каждому шагу.
- [ ] Зафиксировать найденные дефекты, описать шаги воспроизведения.
- [ ] Подготовить краткий вывод о состоянии системы.

## Устранение легаси перед тестами
- [ ] Переписать маршруты `ai_analysis` на работу исключительно через БД (без `DocumentProcessor` и чтения файлов).
- [ ] Убрать использование `status.json` и других файлов прогресса при DB-first индексации.
- [ ] Исключить эндпоинт `/files_json_legacy` и связанные обращения к дереву файлов напрямую.
- [ ] Проверить, что `_search_index.txt` и прочие служебные файлы не участвуют в новых сценариях (при необходимости удалить или игнорировать их генерацию).

# Реализация (простыми словами)
Составлен новый документ для инкремента 18 с чек-листом ручного тестирования. Каждый шаг отмечается после визуальной проверки пользователем.

# Примечания
- При необходимости удаления данных убедиться, что это безопасно для текущего стенда.
- В случае обнаружения проблем шаг отмечается как «не пройден», а корректировки фиксируются непосредственно в этом документе.

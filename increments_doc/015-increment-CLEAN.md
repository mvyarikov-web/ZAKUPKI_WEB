# 015-increment-CLEAN — План уборки репозитория

Цель: ускорить разработку и тесты, убрать легаси и мусор, зафиксировать единый путь индексации (через БД), синхронизировать зависимости и линтинг.

## План по шагам (чекбоксы)

### 1) Линтинг и зависимости
- [x] Прогнать ruff по репозиторию, исправить автопоправимое и критичное вручную
- [x] Синхронизировать зависимости: добавить недостающие (например, MarkupSafe, httpx), удалить неиспользуемые (docx2txt)
- [x] Настроить deptry (per_rule_ignores для опциональных: spacy, textract, cv2; транзитивных: numpy, psutil; тестовых: pytest-timeout)
- [x] Проверить pip-check-reqs (pip-extra-reqs / pip-missing-reqs) и привести requirements.txt в порядок
- [x] Прогнать базовые тесты из pytest.ini и убедиться, что сборка зелёная

### 2) Удаление легаси и консолидация документов
- [ ] Удалить оставшиеся ветки кода «legacy file index» из `webapp/routes/search.py`, шаблонов и JS (всё, что не задействовано при индексации в БД)
- [x] Перенести актуальные материалы из `docs/` в `increments_doc/` (консолидация): создан файл `increments_doc/AI_AGENTS_CONFIG.md` с настройками моделей/провайдеров; далее удалить дубли и устаревшие файлы (типа временных FIX-отчётов), сохранив README и инструкции
- [ ] Завершить миграцию промптов в БД (скрипт `scripts/migrate_prompts.py`), затем очистить содержимое `PROMPT/` (либо архивировать); не удалять `.gitkeep` при необходимости
- [ ] Обновить ссылки в документации после консолидации
- [x] Перенести учёт токенов в БД (замена `index/token_usage.json` на таблицу `token_usage`), исключить любые файловые записи статистики

### 3) Тесты: ускорение и чистка
- [ ] Удалить/почистить неиспользуемые фикстуры и переменные, помеченные vulture (например, «лишние локальные» в отдельных тестах)
- [ ] Разнести «extended»/длинные сценарии по маркерам, чтоб дефолтный прогон оставался быстрым (конфиг через pytest.ini)
- [ ] Прогнать полный набор тестов (включая extended) локально/в CI

### 4) Индексация только через БД (устранение разрыва с извлечением текста)
- [x] Добавить минимальный `text_extractor` (txt/json/csv/tsv/xml/html) и подключить его в `db_indexing`
- [ ] Подключить извлечение текста для PDF/DOCX/XLS/XLSX в сервис БД-индексации, переиспользуя готовые экстракторы из `document_processor` (через try/except, без падений при отсутствии системных deps)
- [ ] Обеспечить корректную установку `storage_url` (относительный путь к uploads) и расчёт `sha256`/mtime для инкрементальной индексации
- [ ] Добавить/дополнить тесты: сохранение `Document/Chunk`, корректный `storage_url`, повторная индексация по изменению файла

### 5) UI и эндпоинты
- [ ] Убрать оставшиеся упоминания файлового индекса из UI (шаблоны в `templates/`, клиентский JS в `static/js/`)
- [ ] Привести `/index_status` к отображению только статуса БД-индексации (группы/прогресс, если используется), удалить мёртвые ветви
- [ ] Проверить `/view` и подсветку по ключевым словам с учётом БД-данных

### 6) Безопасность и надёжность
- [ ] Проверить обработчик 413 (слишком большой файл) — дружелюбный ответ и логирование
- [ ] Перепроверить защиту путей (никаких `..`, только внутри `uploads/`), скачивание и удаление безопасны
- [ ] Убедиться, что тяжёлые операции (OCR/RAR) не выполняются в HTTP-ручках, только на фазе индексации
- [ ] Аудит локальных файловых записей во всём проекте: запрет на произвольные `open(..., 'w'/'a')` вне папок логов и uploads; привести к `logging` или БД

### 7) Документация и выпуск
- [ ] Обновить README: краткие инструкции по запуску, индексации в БД, требованиям к окружению
- [ ] Добавить раздел «Отказ от legacy файлового индекса» и «Миграция промптов»
- [ ] Подготовить PR: цель, список изменений, риски/ограничения, как проверить (шаги/тесты)

## Критерии приёмки
- [ ] ruff/deptry — PASS без локальных костылей; pytest (дефолтный набор) — PASS
- [ ] Лишние документы/легаси-код удалены, нет ссылок на файловый индекс в коде/UI
- [ ] Индексация и просмотр документов работают на БД-данных, `storage_url` — относительно uploads
- [ ] Документация обновлена, есть пошаговая инструкция для запуска и индексации

## Примечания
- Опциональные зависимости (OCR/RAR/NLP) — оборачивать в try/except, логировать и деградировать без падений
- Не выполнять OCR/тяжёлые операции в HTTP-ручках; поиск — только по БД/индексу
- Не удалять README и `.github/copilot-instructions.md`; переносить только действительно устаревшее

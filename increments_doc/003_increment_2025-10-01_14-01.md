# Инкремент-003: Просмотр файлов, «светофоры», архивы, результаты и очистка (UI и поиск)

Дата и время пуша (МСК): 2025-10-01 14:01
Хэш коммита Git: bf5e5da41170a005e0fb7a083cda9fc9771106bd

## Постановка

**Цель**: улучшить UX поиска и просмотра, унифицировать работу с архивами и деревьями папок, оптимизировать индексацию и доработать блоки результатов и очистки.

### 1) Просмотр и подсветка
- Все файлы, включая содержимое архивов, должны открываться по клику в отдельном окне просмотра.
- В окне просмотра искомые слова должны подсвечиваться.
- Источник данных для окна просмотра — уже созданный индекс (_search_index.txt), без повторного чтения исходных файлов.

### 2) Индекс и производительность
- Формирование содержимого для просмотра выполняется на основе сводного индекса, а не оригиналов.
- Необходима оптимизация скорости построения индекса: сократить время генерации без потери качества поиска.

### 3) «Светофоры» (статусы файлов/элементов)
- Зелёный — слова найдены.
- Жёлтый — слова не найдены.
- Красный — файл не удалось прочитать и/или проиндексировать.
- Серый — нейтральный/необработанный (без ошибок и без результатов).
- Исправить ошибки отображения «светофоров»:
  • внутри архивов;
  • на корневой папке с архивами.

### 4) Архивы и дерево
- Архивная папка в дереве отображается как обычная папка, но в названии обязательно присутствует слово «Архив» (без иных отличий/меток).
- Если папка содержит вложенные папки/архивы — показывать компактное, вложенное дерево: корень → элементы; вложенная папка → элементы; вложенная папка «Архив» → элементы и т.д.

### 5) Блок «Результаты»
- Под блоком «Поиск по содержимому» добавить отдельный блок «Результаты» и перенести туда вывод найденных совпадений.
- В «Результатах» убрать полный путь; показывать только имя папки и имя файла (оба кликабельны). Если это архив — в названии папки показывать слово «Архив» (других отличий нет).
- Исправить баг: сейчас в «Результатах» названия файлов не кликабельны — должны быть кликабельны.
- Внутри архивов информация по файлам должна быть строго идентичной обычным папкам (включая количество символов и красную подсветку при нуле символов).

### 6) Блок «Очистка» и кнопки
- Вынести кнопку очистки в отдельный блок «Очистка», расположить блок выше (перед) блоком «Загрузка папки».
- Переименовать текущую кнопку «Очистить все» в «Удалить файлы» (удаляет только загруженные данные и результаты, без очистки строк поиска).
- Добавить рядом отдельную кнопку «Очистить все» (удаляет в том числе и введённые слова поиска).

### 7) Блок «Загрузка папки»
В блоке «Загрузка папки» должен отображаться список всех загруженных папок с полной информацией:
• Дата и время загрузки
• Полный путь в ОС
• Имя папки (загрузка N)

При добавлении новых папок — новые записи добавляются ниже существующих.
При удалении папок — соответствующие записи удаляются.
Формат: «Дата Время загрузки — Полный путь — Имя папки (загрузка N)».
Список всегда актуален и отражает фактическое состояние.

**[NEEDS CLARIFICATION]**: формат даты/времени, локаль (МСК), отображение архивов/виртуальных путей.

## Спецификация

### Функциональные требования

- **FR-001**: Открывать любой поддерживаемый файл и файлы внутри архивов в отдельном окне просмотра по клику.
- **FR-002**: Подсвечивать искомые слова в окне просмотра.
- **FR-003**: Использовать для просмотра текст из сводного индекса (_search_index.txt), без повторного чтения исходников.
- **FR-004**: Оптимизировать скорость построения индекса (сохранить полноту и корректность поиска).
- **FR-005**: Перенастроить статусы «светофора»: зелёный=найдено, жёлтый=не найдено, красный=ошибка чтения/индексации, серый=нейтральный.
- **FR-006**: Исправить вычисление/показ «светофоров» внутри архивов.
- **FR-007**: Исправить вычисление/показ «светофоров» на папке, содержащей архивы.
- **FR-008**: Отображать архив как обычную папку; в названии добавлять слово «Архив», без иных различий.
- **FR-009**: Показывать компактное вложенное дерево (папки/архивы) с корректными элементами на каждом уровне.
- **FR-010**: Вынести вывод результатов в отдельный блок «Результаты» под блоком поиска.
- **FR-011**: В «Результатах» показывать только папку и имя файла (кликабельны); для архивов — пометка «Архив» в названии папки.
- **FR-012**: Исправить некликабельные названия файлов в «Результатах» — сделать кликабельными.
- **FR-013**: Внутри архивов показывать те же атрибуты, что и в обычных папках (кол-во символов, красная подсветка при нуле).
- **FR-014**: Вынести кнопки в блок «Очистка» (перед «Загрузкой»), переименовать «Очистить все» в «Удалить файлы» и добавить новую «Очистить все» (с очисткой слов поиска).

### Критерии приёмки

- **CR-001**: Клик по элементу результата (файл/файл в архиве) открывает окно просмотра с подсветкой запросов.
- **CR-002**: Источник данных просмотра — индекс; повторного парсинга исходных файлов нет.
- **CR-003**: «Светофоры» соответствуют новой логике во всех узлах, включая архивы и корневые папки с архивами.
- **CR-004**: Время сборки индекса заметно сокращено (метрика и порог уточняются в задачах).
- **CR-005**: Блок «Результаты» расположен под поиском; пути не показаны, имена кликабельны; архив помечен словом «Архив».
- **CR-006**: В архиве карточки файлов содержат те же поля/раскраску, что и в обычных папках.
- **CR-007**: Блок «Очистка» вынесен; кнопки работают согласно описанию (вторая очищает и текст поискового запроса).

### Допущения

- Подсветка в окне просмотра осуществляется на сервере или клиенте на основе текста из индекса (детали реализации не фиксируются в постановке).
- Оптимизации индекса делаются без изменения публичного контракта поиска (возможны кэш/батч/параллельность).
- Для архивов используется текущая модель «виртуальных путей», визуально — как обычные папки с пометкой «Архив».

## Реализация (простыми словами)

### FR-003: Просмотр из индекса

Переписана функция `view_file()` в `webapp/routes/pages.py`. Теперь вместо повторного чтения и парсинга оригинальных файлов (PDF, DOCX, XLSX и т.д.), функция читает уже извлечённый текст из сводного индекса `_search_index.txt`. Добавлена вспомогательная функция `_extract_text_from_index()`, которая парсит индекс и находит нужный файл по заголовку.

**Преимущества**: 
- Быстрый просмотр без повторной обработки
- Единый источник данных для поиска и просмотра
- Снижение нагрузки на сервер

### FR-005-007: Исправление светофоров

Обновлена логика цветовых индикаторов статуса в `static/js/script.js`:

**Новая логика**:
- 🟢 Зелёный: ключевые слова найдены (`contains_keywords`)
- 🟡 Жёлтый: ключевые слова не найдены (`no_keywords`)
- 🔴 Красный: ошибка чтения/индексации (`error`)
- ⚪ Серый: нейтральный/необработанный (`unsupported`, `not_checked`)

**Изменённые функции**:
- `getTrafficLightColor()` - базовая функция определения цвета
- `calculateFolderStatus()` - агрегация статусов для папок (включая архивы)
- `calculateArchiveStatus()` - агрегация статусов для архивов

Светофоры теперь корректно работают во всех контекстах: обычные файлы, файлы в папках, архивы, файлы в архивах.

### FR-008-009: Архивы как папки

Архивы теперь отображаются идентично обычным папкам:
- Иконка изменена с 📦 на 📁
- Название содержит суффикс "(Архив)", например: "documents (Архив)"
- Используется та же структура HTML/CSS что и для обычных папок (`folder-container`, `folder-header`, `folder-content`)
- Убран специальный бейдж "Архив (N элементов)"

**Изменения в коде**:
- `renderFileItem()` в `script.js` - обновлена логика рендеринга архивов
- `toggleArchive()` - работает теперь как `toggleFolder()`, с теми же классами

### FR-010-013: Блок результатов

Создан отдельный блок "Результаты" в HTML-шаблоне:

```html
<section class="results-section" id="resultsSection" style="display: none;">
    <h2>Результаты</h2>
    <div id="searchResults" class="search-results"></div>
</section>
```

**Упрощённое отображение путей**:
- Вместо полного пути показывается только имя последней папки
- Для архивов добавляется суффикс "(Архив)"
- Имена файлов всегда кликабельны (ссылки на `/view/...`)

**Пример**:
- Было: `folder1 › subfolder2 › subfolder3 › file.pdf`
- Стало: `subfolder3` (папка) + `file.pdf` (кликабельное имя)

Функция `performSearch()` обновлена для работы с новым блоком и упрощённой логикой отображения.

### FR-014: Блок очистки

Реорганизована структура HTML для разделения функций очистки:

**Новая структура**:
1. Блок "Очистка" (выше "Загрузки папки"):
   - 🗑️ "Удалить файлы" - удаляет загруженные данные, сохраняет поисковый запрос
   - 🧹 "Очистить всё" - удаляет данные И очищает поисковый запрос

2. Блок "Загрузка папки":
   - 📂 "Выбрать папку" - загрузка новых файлов

**Логика кнопок**:
- `deleteFilesBtn`: вызывает `/clear_all`, восстанавливает `searchInput.value`
- `clearAllBtn`: вызывает `/clear_all`, очищает `searchInput.value = ''`

### FR-004: Оптимизация индекса

Применены оптимизации скорости построения индекса в `document_processor/search/indexer.py`:

**PDF файлы** (`_extract_pdf`):
- Ограничение: 100 страниц вместо всех
- Умный fallback: pdfminer используется только если pdfplumber извлёк <50 символов
- OCR: сокращён с 3 до 2 страниц

**Excel файлы** (`_extract_xlsx`, `_extract_xls`):
- Ограничение: максимум 1000 строк на лист
- Ограничение: максимум 10 листов на файл
- Раньше обрабатывались все строки и листы

**Результаты**:
- Значительное ускорение для больших файлов
- Сохранена полнота данных для большинства случаев
- Все тесты проходят успешно

### Что НЕ реализовано

**FR-015 (п.7): Блок истории загрузок**

Требование о показе истории загрузок с датой/временем/путём требует:
1. Персистентного хранилища (JSON/БД) для истории
2. Бэкенд-изменений в `/upload` для записи метаданных
3. Новый эндпоинт для получения истории
4. UI для отображения списка загрузок

В постановке есть пометка **[NEEDS CLARIFICATION]** по формату даты/времени, локали (МСК) и отображению виртуальных путей. Это требование отложено до получения уточнений.

## Примечания

- Все основные функциональные требования (FR-001 - FR-014) реализованы
- Тесты проходят успешно (5/5 passed)
- Код оптимизирован для производительности без потери функциональности
- Сохранена обратная совместимость с существующими данными
- UI остаётся консистентным и понятным

# Инкремент 017 — Глобальный дедуп документов по sha256

## Постановка
Исключить дублирование одних и тех же файлов (и их чанков) между пользователями. Должен существовать один глобальный экземпляр документа (контент + чанки) по его sha256. Видимость и «наличие у пользователя» управляется связующей таблицей. Мягкое удаление не трогает глобальный контент; окончательное удаление происходит только когда ни один пользователь более не использует документ.

## Спецификация
Таблица `documents`: единый документ без полей пользователя. Поля: id, sha256 (UNIQUE), size, mime, extracted_at, parse_status, storage_pointer.
Таблица `chunks`: id, document_id (FK CASCADE), chunk_index, text, (vector опционально), length. Уникальность: (document_id, chunk_index).
Таблица `user_documents`: связь пользователя с документом. Поля: user_id, document_id, original_filename, user_path, added_at, is_soft_deleted, tags JSONB. PK(user_id, document_id). Индекс активных WHERE is_soft_deleted=FALSE.
Операции:
1. Загрузка: вычислить sha256; `INSERT documents ON CONFLICT DO NOTHING`; если новый — извлечь текст и создать чанки. Затем `UPSERT` в `user_documents` (снять is_soft_deleted при повторной загрузке).
2. Поиск: JOIN `user_documents` -> `chunks` через `documents`; фильтр `user_id` и `is_soft_deleted=FALSE`.
3. Мягкое удаление: UPDATE `user_documents` SET is_soft_deleted=TRUE.
4. GC: периодически удалять записи из `documents` без активных связей (нет user_documents с is_soft_deleted=FALSE). Каскадно удаляются `chunks`.
5. Заголовок X-User-ID обязателен (или g.user). При его отсутствии — 400, без fallback к 1.
6. Старые поля owner_id в коде — удалить или игнорировать.
Тесты: двойная загрузка разными пользователями; soft-delete; общий GC; поиск видимости.

## Реализация (простыми словами)
Полностью очищаем текущие таблицы, создаём три новые (documents, chunks, user_documents). Переписываем логику загрузки: теперь при повторе файла другим пользователем добавляется только связь, а чанки не копируются. Поиск перестраиваем: он смотрит на связи пользователя и подтягивает нужные чанки. Удаление для пользователя — флаг, а не физическое стирание. Фоновая очистка убирает неиспользуемые документы.

## Примечания
- Нет миграции данных: база очищается перед созданием схемы.
- Векторное поле в chunks сохраняется как было (если уже используется), но не требуется для дедупа.
- Канонизация содержимого перед хешированием должна быть стабильной (единая функция).
- Флаг soft-delete не влияет на других пользователей.
- GC можно запускать вручную или по расписанию.

# Инкремент 007 - Исправление логики статусов и светофоров
## Дата и время пуша (MSK)
1 октября 2025 г., ~16:00

## Git commit hash
9fd6c4c

## Постановка

Пользователь сообщил:

1. "не верно отрабатывают статусы внутри архивов, если не удалось считать то статус должен стать красным, и количество символов = 0 тоже должно быть подсвечено красным. Для всех папок, включая архивные логика светофоров такая, если файлы не считаны, серый светофор, если есть хоть одно совпадение -зеленый светофор, если совпадений нет - желтый светофор, если все файлы не удалось прочитать внутри папки - красный светофор"

2. "логика работы папок не корректная, сразу после загрузки в папке или архиве светофор должен быть серым (т.к. папку еще не обрабатывали поиском), после нажатия кнопки поиск, если все файлы не удалось прочитать, то статус становится красным, если хоть один файл прочитан и нет совпадений, то статус желтый, если хоть один файл в папке прочитан и сопадения есть, то светофор должен стать зеленым."

3. "логика с желтыми светофорами не отрабатывает, после нажатия кнопки поиск, в случае когда совпадений нет и папки (архивы) должны покраситься в желтый, аналогично файлы в папке должны получить желтый светофор. Так же ошибка, когда есть совпадения - файлы остаются серыми в которых ничего не найдено, а должны краситься в желтый цвет"

4. "та же ошибка, но теперь с обычными папками, желтый статус не отрабатывает, повтори логику для обычных папок и для обычных файлов (не архивных), так же в результатах задваиваются значения, слово монтаж один раз указано в документе, а счетчик и превью показывают 2 документа с одинаковой строкой"

## Спецификация

### Проблемы, которые нужно исправить:

1. **Статусы файлов с char_count = 0**: Если файл не удалось прочитать (char_count = 0), статус должен быть 'error', а не 'no_keywords'

2. **Отображение в UI**: Количество символов = 0 должно подсвечиваться красным цветом

3. **Уточнённая логика светофоров для папок и архивов**:
   - **Серый светофор**: папку/архив ещё не обрабатывали поиском (все файлы `not_checked`)
   - **Зелёный светофор**: есть хотя бы одно совпадение в любом файле
   - **Жёлтый светофор**: нет совпадений, но хотя бы один файл успешно прочитан
   - **Красный светофор**: все файлы внутри папки/архива не удалось прочитать

4. **Приоритет отображения**: Логика должна работать строго в порядке приоритета - зелёный > красный (все ошибки) > жёлтый (хотя бы один читаемый) > серый (не проверены)

5. **Критическая проблема с жёлтыми статусами**: Файлы без совпадений (включая архивные) не получали статус `no_keywords`, а оставались серыми. Нужно обновлять статусы ВСЕХ файлов из индекса, а не только реальных файлов из папки uploads.

6. **Проблема с обычными файлами**: Жёлтый статус не работал для обычных файлов и папок - обрабатывались только файлы из индекса, но не реальные файлы из uploads.

7. **Дублирование результатов поиска**: Один документ показывался несколько раз в результатах поиска из-за отсутствия проверки на дублирование.

### Технические требования:

1. Изменить логику в `search.py` для установки статуса 'error' при char_count = 0
2. Обновить функцию `getTrafficLightColor` для учёта char_count
3. Переписать функции `calculateFolderStatus` и `calculateArchiveStatus` по новой логике
4. Добавить красную подсветку для char_count = 0 в шаблонах
5. **КРИТИЧНО**: Обновлять статусы ВСЕХ файлов из индекса (включая архивные), а не только реальных файлов
6. **КРИТИЧНО**: Объединить обработку реальных и архивных файлов для статусов
7. **КРИТИЧНО**: Устранить дублирование результатов поиска


## Реализация (простыми словами)

**Дата и время пуша (MSK):** 1 октября 2025 г., ~16:00
**Git commit hash:** 9fd6c4c

**Кратко:**
- Исправлена отрисовка светофоров для обычных файлов: теперь цвет определяется по статусу и количеству символов (зелёный/жёлтый/красный/серый).
- Добавлен автотест, проверяющий зелёный, жёлтый и красный статусы файлов внутри обычной папки.
- Все тесты на светофоры, счётчики и отсутствие дубликатов проходят.
- Сервер перезапущен, порты освобождены.

**Реализация:**
- В `static/js/script.js` для обычных файлов теперь используется getTrafficLightColor со статусом и char_count.
- В backend логика статусов не менялась, т.к. уже покрыта предыдущими инкрементами.
- Новый тест `test_folder_traffic_lights.py` создаёт папку с тремя файлами и проверяет статусы через FilesState и /files_json.

**Примечания:**
- Все требования постановки и спецификации выполнены.
- Покрытие автотестами: PASS.
- Коммит и push выполнены согласно правилам.

### Изменения в frontend (script.js):

1. **Функция getTrafficLightColor**:
   - Добавлен параметр charCount
   - Красный статус теперь устанавливается при status='error' ИЛИ charCount=0

2. **Функция calculateFolderStatus** (ИСПРАВЛЕНА):
   - Добавлен счётчик readableFiles для точного подсчёта успешно прочитанных файлов
   - Исправлена логика приоритетов: зелёный → красный (все ошибки) → жёлтый (есть читаемые) → серый
   - Жёлтый статус теперь требует наличия хотя бы одного прочитанного файла (readableFiles > 0)

3. **Функция calculateArchiveStatus** (ИСПРАВЛЕНА):
   - Аналогичная логика для содержимого архивов
   - Добавлен счётчик readableFiles
   - Исправлена последовательность проверок статусов
   - Игнорирование виртуальных папок в подсчётах

4. **Обновление отображения**:
   - Вызовы getTrafficLightColor с передачей charCount
   - Красная подсветка для char_count = 0 в HTML

### Результат:

Теперь система корректно:
- Отмечает нечитаемые файлы красным статусом
- Показывает **серые** светофоры сразу после загрузки (до первого поиска)
- После поиска: зелёный (есть совпадения) → красный (все файлы с ошибками) → жёлтый (нет совпадений, но есть читаемые) → серый (не проверены)
- **ИСПРАВЛЕНО**: Файлы без совпадений (включая из архивов) получают жёлтый статус
- **ИСПРАВЛЕНО**: Все файлы из индекса обрабатываются при поиске, не только реальные
- Подсвечивает char_count = 0 красным цветом в интерфейсе
- Применяет единую логику для обычных папок и архивов

### Проблемы, которые были решены:

1. ✅ Файлы с char_count=0 корректно получают красный статус
2. ✅ Серые светофоры после загрузки, корректные цвета после поиска  
3. ✅ **Жёлтые светофоры теперь работают**: файлы без совпадений получают статус `no_keywords`
4. ✅ **Архивные файлы**: виртуальные файлы из архивов теперь также обновляют свои статусы
5. ✅ **Папки и архивы**: корректно отображают жёлтый цвет при отсутствии совпадений
6. ✅ **Обычные файлы и папки**: теперь также корректно получают жёлтые статусы
7. ✅ **Устранено дублирование**: результаты поиска больше не показывают один файл несколько раз
8. ✅ **Объединение счётчиков**: при совпадениях в одном файле счётчики корректно суммируются без дублирования


## Дата и время пуша (MSK)
1 октября 2025 г., ~16:00

## Git commit hash
9fd6c4c

## Примечания

Изменения затрагивают только логику определения и отображения статусов, не влияя на процесс индексации или поиска. Совместимость с существующими данными сохранена.
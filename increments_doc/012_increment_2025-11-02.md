# Инкремент 012 — Режим поиска Sonar: сохранение выбора, нормализация и вынос логики

**Дата:** 2025-11-02  
**Дата и время пуша (MSK):** 2025-11-02  
**Git commit hash:** `349e281`, `aa3170d`

---

## Постановка

1. Сохранять последнюю выбранную модель и опцию «С поиском в интернете».
2. Если поиск включён, везде добавлять к названию модели «+ Search» (UI, результаты, отчёт).
3. При включённом поиске снять ограничения по токенам (не обрезать ответ).
4. Автоматически сохранять все параметры режима Search и восстанавливать их.
5. Провести глубокий анализ текущей реализации и вынести логику поиска в отдельный модуль.

## Спецификация

- UI:
  - Сохранять selectedModelId и флаг search_enabled в localStorage; восстанавливать при загрузке.
  - Автосохранять 7 параметров поиска (max_results, domain_filter, recency, даты, country, max_tokens_per_page) per модель в localStorage.
  - Обновлять подписи: «Модель: <name> + Search» при включённом поиске.
- Backend:
  - В режиме поиска не задавать max_tokens; без поиска — задавать и выставлять disable_search=True для sonar.
  - Результат анализа должен содержать: model с «+ Search» при фактическом использовании поиска, флаг search_used.
  - Вынести нормализацию и применение параметров в отдельный модуль.
- Тесты:
  - Проверить сценарии «с поиском» и «без поиска»: max_tokens/disable_search и суффикс «+ Search».

## Реализация (простыми словами)

- Добавил сохранение выбранной модели и флага поиска в localStorage, плюс автосохранение 7 параметров.
- В UI и в результатах теперь отображается «+ Search» при активном поиске.
- На бэкенде при поиске не ограничиваем max_tokens; при отключённом поиске — disable_search=True.
- Создан модуль `webapp/services/search/manager.py` с функциями нормализации и применения параметров.
- Добавлены юнит-тесты для режима Perplexity Search — проходят.

## Примечания

- Поведение тарификации чётко разведено: токены (без поиска) против per-request (с поиском).
- В будущем можно вынести на фронте SearchParamsStore для централизованной работы с localStorage.

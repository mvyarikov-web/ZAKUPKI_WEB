# increment-000 — Консолидация существующей документации и истории проекта

Дата и время пуша (MSK): 2025-10-01 00:57
Git commit hash: 553293aad21cf13cbc1ab6aca9bf81e58d2dba95

## Постановка

Это нулевое приращение представляет собой консолидацию всей существующей документации проекта ZAKUPKI_WEB на момент внедрения системы управления документацией приращений.

Проект ZAKUPKI_WEB — это веб-приложение на базе Flask для автоматизированного поиска и обработки документов закупок различных форматов (PDF, DOC, DOCX, XLS, XLSX, TXT), включая обработку архивов (ZIP/RAR), с поддержкой OCR для извлечения текста из изображений.

Основные возможности:
- Загрузка файлов и папок через drag & drop
- Рекурсивная индексация с поддержкой вложенных папок и архивов
- Создание сводного индекса `_search_index.txt`
- Быстрый поиск по ключевым словам с игнорированием заголовков
- Извлечение текста с учётом различных кодировок и кириллицы
- OCR для сканированных документов (Tesseract)
- Веб-интерфейс с просмотром результатов и управлением файлами

## Спецификация

### Архитектура и стек технологий

**Основной стек:**
- Python 3.9+
- Flask (веб-фреймворк)
- Jinja2 (шаблоны)
- JavaScript (vanilla), HTML/CSS

**Модульная архитектура:**
```
webapp/
├── __init__.py          # Factory pattern (create_app)
├── config.py           # Конфигурации (Dev/Prod/Testing)
├── routes/             # Blueprints
│   ├── pages.py        # Страницы
│   ├── files.py        # Работа с файлами
│   ├── search.py       # Поиск и индексация
│   └── health.py       # Health check
├── services/           # Бизнес-логика
│   ├── files.py        # Утилиты для файлов
│   ├── indexing.py     # Обёртка над DocumentProcessor
│   └── state.py        # Управление состоянием
└── utils/              # Вспомогательные утилиты
    ├── logging.py      # Логирование
    └── errors.py       # Обработчики ошибок

document_processor/     # Модуль индексации/поиска
├── core.py            # DocumentProcessor (API)
├── extractors/        # Извлечение текста
│   ├── pdf_extractor.py
│   ├── docx_extractor.py
│   ├── doc_extractor.py
│   ├── excel_extractor.py
│   ├── text_extractor.py
│   └── archive_extractor.py
├── ocr/               # OCR обработка
│   ├── tesseract_ocr.py
│   └── image_processor.py
├── utils/             # Утилиты
│   ├── encoding_detector.py
│   ├── file_validator.py
│   ├── path_utils.py
│   └── text_cleaner.py
└── search/            # Индексация и поиск
    ├── indexer.py     # Генерация _search_index.txt
    └── searcher.py    # Поиск по индексу
```

### Модуль обработки файлов (document_processor)

**Основные функции:**

1. **Индексация (indexer.py):**
   - Рекурсивный обход папок с ограничением глубины (MAX_DEPTH=10)
   - Обработка архивов ZIP и RAR (с распаковкой во временные директории)
   - Поддержка виртуальных путей: `zip://path/to/archive.zip!/file.docx`, `rar://path/to/archive.rar!/file.pdf`
   - Защита от ZipSlip (нормализация путей)
   - Ограничения: размер архива (500 МБ), количество элементов (5000), глубина вложенности
   - Создание сводного файла `_search_index.txt` в UTF-8

2. **Формат сводного индекса:**
```
================================
ЗАГОЛОВОК: [ОТНОСИТЕЛЬНЫЙ_ПУТЬ_ДОКУМЕНТА_ИЛИ_ИСТОЧНИК]
Формат: [PDF|DOC|DOCX|XLS|XLSX|TXT] | Символов: [N] | Дата: [YYYY-MM-DD HH:MM] | OCR: [да/нет] | Качество: [0–100%]
Источник: [filesystem|zip://...|rar://...]
================================
[Нормализованный текст документа]
```

3. **Извлечение текста:**
   - **PDF:** pdfplumber (основной) → pypdf (fallback) → OCR для сканов
   - **DOCX:** python-docx (параграфы + таблицы + извлечение картинок для OCR)
   - **DOC:** docx2txt (fallback) + бинарное извлечение
   - **XLSX:** openpyxl (тексты из ячеек)
   - **XLS:** xlrd (старые Excel)
   - **TXT:** автоопределение кодировки (chardet) с fallback: UTF-8 → cp1251 → cp866 → iso-8859-1

4. **OCR и обработка изображений:**
   - Tesseract OCR с языками rus+eng
   - Предобработка: оттенки серого, бинаризация, увеличение резкости/контраста
   - Извлечение изображений из PDF (pdf2image) и DOCX
   - Конфигурация: лимит страниц (10), таймаут (20 сек)
   - Graceful degradation при отсутствии Tesseract

5. **Нормализация и качество текста:**
   - Unicode нормализация (NFKC)
   - Удаление невидимых/управляющих символов
   - Схлопывание пробелов
   - Метрики качества: длина текста, доля буквенных символов, процент кириллицы
   - Качество (0–100%) как агрегат метрик

6. **Поиск (searcher.py):**
   - Поиск только по `_search_index.txt`
   - Игнорирование заголовков (строки с `====`, `ЗАГОЛОВОК:`, `Формат:`, `Источник:`)
   - Регистронезависимый поиск, Unicode-совместимый
   - Возврат контекстных фрагментов (±80 символов по умолчанию)
   - Простое ранжирование: документы с большим числом совпадений — выше

### Веб-слой (Flask приложения)

**Структура папок:**
- `uploads/` — загруженные пользователями файлы (только поддерживаемые форматы)
- `index/` — технические файлы: `_search_index.txt`, `search_results.json`
- Неподдерживаемые файлы не копируются в `uploads/`, но отображаются в UI с серой заливкой

**Основные эндпоинты:**

**Страницы (pages.py):**
- `GET /` — главная страница с файлами и результатами поиска
- `GET /view/<path>` — просмотр содержимого файла с подсветкой терминов

**Файлы (files.py):**
- `POST /upload` — загрузка файлов/папок (сохранение только поддерживаемых форматов)
- `DELETE /delete/<path>` — удаление файла
- `DELETE /delete_folder/<path>` — удаление папки
- `GET /download/<path>` — скачивание файла (с проверкой безопасного пути)
- `GET /files_json` — JSON-дерево файлов/папок

**Поиск (search.py):**
- `POST /search` — поиск по ключевым словам (использует индекс; создаёт автоматически если отсутствует)
- `POST /build_index` — явная пересборка индекса
- `GET /index_status` — статус индексного файла (наличие, размер)
- `GET /view_index` — просмотр сводного индекса
- `POST /clear_results` — очистка результатов

**Health check (health.py):**
- `GET /health` — проверка работоспособности (200 OK, JSON)

**Безопасность:**
- Проверка путей через `is_safe_subpath()` (защита от directory traversal)
- Санитизация имён файлов через `safe_filename()` (с сохранением кириллицы)
- Фильтрация временных Office-файлов (`~$`, `$`)
- Ограничение размера файлов: `MAX_CONTENT_LENGTH = 100 MB`
- Whitelist разрешённых расширений

**Логирование:**
- Файл: `logs/app.log` (UTF-8, ежедневная ротация, 7 архивов)
- Формат: `%(asctime)s %(levelname)s [%(name)s] %(module)s:%(lineno)d - %(message)s`
- Логируются: загрузка/удаление файлов, сборка индекса, поиск, ошибки с трейсбэком, HTTP-запросы с временем
- Уровень: INFO по умолчанию
- Request ID для трейсинга

**Конфигурация:**
- Классы: `Config` (базовая), `DevConfig`, `ProdConfig`, `TestingConfig`
- Переменные окружения: `FLASK_ENV`, `SECRET_KEY`, `FLASK_HOST`, `FLASK_PORT`, `FLASK_DEBUG`
- Factory pattern: `create_app(config_name)`

**Состояние приложения:**
- `FilesState` с файловой блокировкой (fcntl) для атомарных операций
- Файл: `index/search_results.json`
- Thread-safe для параллельных запросов

### Зависимости

**Python-пакеты:**
```
Flask>=2.3.0
pdfplumber>=0.11.7
pypdf>=5.0.0
python-docx>=0.8.11
docx2txt>=0.8
openpyxl>=3.1.2
xlrd>=2.0.1
chardet>=5.0.0
pytesseract>=0.3.10
Pillow>=10.0.0
pdf2image>=3.1.0
rarfile>=4.2
```

**Системные зависимости:**
- Tesseract OCR + языковые модели rus, eng (опционально, для OCR)
- unrar (опционально, для RAR-архивов) — macOS: `brew install unrar`

### Практики разработки

1. **Минимальные изменения**: всегда делаем минимальные изменения с максимальным сохранением функционала
2. **Русскоязычность**: вся документация, интерфейс, сообщения об ошибках — на русском (кроме имён переменных/функций/классов)
3. **PEP 8**: соблюдение стандарта, type hints, понятные докстринги (Google/Numpy style)
4. **Безопасность**: проверка путей, санитизация имён, защита от traversal, ограничения размеров
5. **Устойчивость**: обработка ошибок без падения всего процесса, graceful degradation при отсутствии системных зависимостей
6. **Логирование**: ключевые события и ошибки в `logs/app.log`
7. **Тестирование**: pytest, фикстуры, маркеры `@pytest.mark.skipif` для условных тестов

### Запуск и развёртывание

**Разработка:**
```bash
python app.py  # Запуск dev-сервера
# или
export FLASK_APP=app.py
export FLASK_ENV=dev
flask run
```

**Продакшен:**
```bash
gunicorn 'wsgi:app' -w 4 -b 127.0.0.1:8081
# или
uwsgi --http :8081 --wsgi-file wsgi.py --callable app
```

**Тестирование:**
```bash
pytest -q  # Быстрый запуск
pytest tests/ -v  # Подробный вывод
pytest --cov=webapp tests/  # С покрытием
```

**Настройки:**
- Хост: 127.0.0.1 (по умолчанию)
- Порт: 5000 (dev) / 8081 (prod)
- Максимальный размер загрузки: 100 MB
- Автоматическая пересборка индекса: после загрузки, перед поиском, после удаления

### Тестирование (автотесты)

**Структура тестов:**
```
tests/
├── conftest.py                      # Общие фикстуры
├── test_indexer_basic.py           # Базовая индексация
├── test_archives.py                # ZIP/RAR
├── test_encoding_cyrillic.py       # Кодировки и кириллица
├── test_ocr_optional.py            # OCR (skipif без Tesseract)
├── test_searcher.py                # Поиск и игнор заголовков
├── test_resilience_broken_files.py # Устойчивость
├── test_flask_endpoints.py         # Flask эндпоинты
└── ...
```

**Ключевые фикстуры:**
- `tmp_path` (pytest) — временная рабочая директория
- `make_files` — генерация файлов разных типов
- `ensure_env` — проверка наличия tesseract/unrar

**Контракты:**
- `DocumentProcessor.create_search_index(root_folder: str) -> str` — создаёт индекс, возвращает путь
- `DocumentProcessor.search_keywords(index_path: str, keywords: list[str], context: int = 80) -> list[dict]` — ищет и возвращает сниппеты

**Проверяемые сценарии:**
1. Базовая индексация файлов разных форматов
2. Рекурсивная обработка вложенных папок
3. Обработка архивов (ZIP/RAR) с виртуальными путями
4. OCR для изображений в PDF и DOCX
5. Корректная обработка кириллицы и различных кодировок
6. Поиск с игнорированием заголовков и выдачей сниппетов
7. Устойчивость к битым/неподдерживаемым файлам
8. Flask-эндпоинты (загрузка, удаление, поиск)

## Реализация (простыми словами)

**Что было сделано к моменту консолидации:**

1. **Модуль обработки документов (document_processor):**
   - Создана полная архитектура модуля с разделением на extractors (извлечение), ocr (распознавание), search (индексация/поиск), utils (утилиты)
   - Реализованы извлекатели для всех основных форматов: PDF, DOCX, DOC, XLSX, XLS, TXT
   - Добавлена поддержка архивов ZIP и RAR с рекурсивной обработкой содержимого
   - Реализован OCR через Tesseract с автоматическим определением языка (rus+eng)
   - Создан механизм автоопределения кодировок с fallback-цепочкой для корректной работы с кириллицей
   - Разработана система нормализации и оценки качества извлечённого текста
   - Реализован поисковик с игнорированием заголовков и выдачей контекстных сниппетов

2. **Рефакторинг веб-приложения:**
   - Монолитный app.py (1286 строк) разбит на модульную структуру (17 модулей)
   - Внедрён Factory pattern с функцией `create_app()`
   - Созданы blueprints для логического разделения роутов: pages, files, search, health
   - Вынесена бизнес-логика в services: files, indexing, state
   - Реализована атомарная работа с состоянием через `FilesState` с файловой блокировкой (fcntl)
   - Настроено профессиональное логирование с ротацией и request ID
   - Добавлены конфигурации для разных окружений (dev/prod/testing)
   - Создан wsgi.py для продакшен-развёртывания

3. **Безопасность:**
   - Реализована защита от directory traversal через проверку безопасных путей
   - Добавлена санитизация имён файлов с сохранением кириллицы
   - Внедрены ограничения на размер загружаемых файлов (100 MB)
   - Фильтрация временных Office-файлов
   - Whitelist разрешённых расширений

4. **Пользовательский интерфейс:**
   - Drag & Drop загрузка папок с сохранением структуры
   - Кнопка "Открыть папку" для выбора через диалог
   - Отображение файлов в иерархической структуре с возможностью сворачивания/разворачивания
   - Показ размеров файлов и статусов обработки
   - Выделение неподдерживаемых форматов серым цветом
   - Подсветка красным файлов с 0 распознанных символов
   - Вывод сниппетов поиска с подсветкой ключевых слов на главной странице
   - Просмотр содержимого файлов в отдельной вкладке с подсветкой терминов
   - Кнопка "Сводный файл в TXT" для просмотра индекса

5. **Автотесты:**
   - Создан полный набор pytest-тестов для всех основных сценариев
   - Тесты для индексации, извлечения, поиска, архивов, OCR, кодировок
   - Тесты Flask-эндпоинтов
   - Фикстуры для генерации тестовых данных
   - Условные тесты с `@pytest.mark.skipif` для системных зависимостей
   - Все базовые тесты проходят успешно

6. **Документация:**
   - Создана техническая постановка модуля обработки файлов
   - Написан план автотестов с описанием сценариев
   - Подготовлено руководство по архитектуре приложения (ARCHITECTURE.md)
   - Составлено руководство по миграции (MIGRATION_GUIDE.md)
   - Создана сводка рефакторинга (REFACTORING_SUMMARY.md)
   - Обновлён README.md с описанием функциональности

7. **Инфраструктура:**
   - Настроена ротация логов (ежедневная, хранение 7 архивов)
   - Добавлена поддержка переменных окружения для конфигурации
   - Созданы обработчики ошибок (JSON/HTML)
   - Реализован health check эндпоинт
   - Добавлен .gitignore для исключения служебных файлов

**Текущее состояние проекта:**
- Приложение полностью функционально и готово к использованию
- Код отрефакторен и соответствует best practices
- Все тесты проходят
- Документация актуальна
- Проект готов к продакшен-развёртыванию

**Техническая задолженность:**
- Кэширование результатов извлечения текста (по хешу файла и mtime) — пока не реализовано
- Параллелизм при извлечении текста — на будущее для повышения производительности
- Глубокая обработка вложенных архивов (архив в архиве) — по умолчанию отключено
- Улучшение извлечения текста из старых DOC-файлов
- Добавление поддержки дополнительных форматов (по запросу)

## Примечания

**Консолидированные файлы:**

Из папки `specs/`:
- `001-/spec.md` — спецификация обработки архивов как папок
- `001-/002-spec.md` — постановка и спецификация системы управления документацией приращений

Из папки `docs/`:
- `Постановка_модуль_обработки_файлов.md` — техническая постановка и план модуля обработки
- `Автотесты_модуль_обработки_файлов.md` — план автотестов
- `ARCHITECTURE.md` — архитектура приложения
- `MIGRATION_GUIDE.md` — руководство по миграции
- `STRUCTURE.txt` — структура проекта (устаревший файл)

Из корня:
- `REFACTORING_SUMMARY.md` — итоговая сводка рефакторинга

**Сохранённые файлы (исключения из удаления):**
- `.specify/memory/constitution.md` — базовые инструкции для Copilot (конституция проекта)
- `.github/copilot-instructions.md` — инструкции для GitHub Copilot
- `README.md` — общее описание проекта

**Важные договорённости:**
- Индекс `_search_index.txt` создаётся автоматически в папке `index/`, а не в `uploads/`
- Поиск всегда выполняется только по индексу, никогда по исходным файлам
- Заголовки в индексе не участвуют в поиске
- OCR и RAR — опциональные зависимости, graceful degradation при их отсутствии
- Все пути проверяются на безопасность
- Неподдерживаемые файлы отображаются в UI, но не индексируются

**Следующие шаги:**
- Внедрение системы управления документацией приращений (текущая задача)
- Дальнейшая разработка согласно новым приращениям в папке `increments_doc/`
- Постепенное улучшение производительности и функциональности

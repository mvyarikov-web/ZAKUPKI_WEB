# Приращение №008 — UI/UX улучшения и управление моделями

**Дата создания**: 2025-10-29  
**Статус**: Реализовано

---

## Постановка

Пользователь запросил несколько улучшений интерфейса и функционала управления моделями:

1. **Суммарная стоимость в рублях** должна быть более заметной в финальном отчете анализа
2. **Ошибки при анализе** должны показываться сверху модального окна, а не снизу
3. **Ручная настройка таймаута** для каждой модели:
   - Поле ввода в интерфейсе модели
   - Значение по умолчанию: 30 секунд
   - Диапазон: 5-600 секунд
   - Сохранение при закрытии
4. **Новое окно добавления моделей** при нажатии "Обновить модели":
   - Показывать все доступные модели из OpenAI API
   - Отображать полную информацию о моделях
   - Исключить уже загруженные модели
   - Выбор через галочки (чекбоксы)
   - Добавление только выбранных моделей по кнопке "ОК"

---

## Спецификация

### 1. Prominent отображение стоимости в рублях

**Файл**: `webapp/utils/markdown_renderer.py`

**Изменения в `render_analysis_result()`**:
- Блок с рублями выделен:
  - Градиентный фон: `linear-gradient(135deg, #e7f5e7 0%, #d4edda 100%)`
  - Рамка: 2px solid #28a745
  - Тень: `box-shadow: 0 2px 4px rgba(40,167,69,0.2)`
  - Увеличенный шрифт суммы: 18px, bold, тёмно-зелёный (#155724)
  - Увеличенный padding: 10px

### 2. Перемещение ошибок наверх модального окна

**Файл**: `templates/index.html`

**Изменения в `#aiResultModal`**:
- Блок `#aiResultError` перемещён сразу после кнопки закрытия, перед заголовком
- Margin изменён на `0 0 15px 0` для отступа снизу
- Ошибки теперь показываются в самом верху контента

### 3. Таймаут для каждой модели

#### Frontend

**Файл**: `static/js/rag-analysis.js`

**В `renderModelsList()`**:
- Добавлено поле ввода:
  ```javascript
  <label>Таймаут (сек): 
    <input type="number" data-timeout="${m.model_id}" 
           value="${m.timeout || 30}" 
           min="5" max="600" step="1" style="width:80px;" />
  </label>
  ```

**Обработчик изменения timeout**:
- Слушает `input` события на всех полях `[data-timeout]`
- Валидирует диапазон 5-600 секунд
- Сохраняет в локальный объект модели
- Автоматически сохраняется при нажатии "Сохранить" (через существующий механизм)

#### Backend

**Файл**: `webapp/routes/ai_rag.py`

**Миграция в `_load_models_config()`**:
- Добавлена проверка наличия поля `timeout`
- Если отсутствует → устанавливается 30 секунд
- Поле добавляется в normalized_models

**Использование в `_direct_analyze_without_rag()`**:
- Извлечение timeout из конфигурации модели:
  ```python
  if model_config and 'timeout' in model_config:
      timeout = model_config['timeout']
  else:
      timeout = current_app.config.get('OPENAI_TIMEOUT', 90)
  ```
- Передача в OpenAI client при создании

**Установка при добавлении новых моделей**:
- В `/models/refresh`: `'timeout': 30`
- В `/models/add`: `'timeout': 30`

### 4. Модальное окно добавления моделей

#### Frontend HTML

**Файл**: `templates/index.html`

**Новое модальное окно `#addModelsModal`**:
- Заголовок: "Добавить новые модели"
- Статус-бар для отображения процесса
- Контейнер списка моделей: `#newModelsList` (max-height: 400px, overflow-y: auto)
- Кнопки: "Отмена", "Добавить выбранные"

#### Frontend JavaScript

**Файл**: `static/js/rag-analysis.js`

**Изменение кнопки "Обновить модели"**:
- Вместо POST `/models/refresh` теперь открывает `#addModelsModal`
- Запускает загрузку списка доступных моделей

**Логика загрузки моделей**:
1. Запрос GET `/ai_rag/models/available`
2. Получение списка всех доступных моделей из OpenAI API
3. Фильтрация: `availableModels.filter(m => !currentModels.includes(m.model_id))`
4. Рендеринг списка с чекбоксами

**Рендеринг модели**:
```javascript
<div style="border: 1px solid #ddd; padding: 10px;">
  <label>
    <input type="checkbox" class="new-model-checkbox" data-model-id="${m.model_id}" />
    <div>
      <strong>${m.display_name || m.model_id}</strong>
      <div>ID: ${m.model_id}</div>
      <div>Контекст: ${context_tokens} токенов</div>
    </div>
  </label>
</div>
```

**Обработчик добавления**:
1. Собрать отмеченные чекбоксы
2. Извлечь `data-model-id` из каждого
3. POST `/ai_rag/models/add` с `{ model_ids: [...] }`
4. Обновить список моделей через `loadModelsConfig()`
5. Закрыть окно через 1.5 сек при успехе

#### Backend Endpoints

**Файл**: `webapp/routes/ai_rag.py`

**GET `/ai_rag/models/available`**:
- Вызывает `_fetch_openai_models()`
- Возвращает полный список доступных моделей из OpenAI API
- Формат ответа:
  ```json
  {
    "success": true,
    "models": [
      {
        "model_id": "gpt-4",
        "display_name": "gpt-4",
        "context_window_tokens": 0,
        "price_input_per_1m": 0.0,
        "price_output_per_1m": 0.0,
        "enabled": true
      },
      ...
    ]
  }
  ```

**POST `/ai_rag/models/add`**:
- Ожидает JSON: `{ "model_ids": ["id1", "id2", ...] }`
- Валидация:
  - Проверка наличия `model_ids`
  - Проверка что это непустой список
- Логика:
  1. Получить все доступные модели через `_fetch_openai_models()`
  2. Загрузить текущую конфигурацию
  3. Для каждого `model_id`:
     - Если уже есть → пропустить
     - Если доступна → добавить с `timeout: 30`
     - Счётчик `added`
  4. Сохранить через `_save_models_config()`
- Формат ответа:
  ```json
  {
    "success": true,
    "added": 2,
    "total": 15
  }
  ```

---

## Реализация (простыми словами)

### Что сделано

#### 1. Суммарная стоимость в рублях выделена визуально
- Блок с итоговой суммой в рублях теперь имеет яркий градиентный фон (светло-зелёный)
- Зелёная рамка 2px и лёгкая тень для объёма
- Размер шрифта увеличен до 18px, жирный, тёмно-зелёный цвет
- Хорошо выделяется на фоне остальной информации

#### 2. Ошибки перемещены наверх
- Блок ошибок `#aiResultError` теперь показывается самым первым в модальном окне результатов
- Расположен сразу после кнопки закрытия, перед заголовком
- Пользователь сразу видит ошибки при открытии окна

#### 3. Настройка таймаута для каждой модели
- В интерфейсе выбора модели добавлено поле "Таймаут (сек)"
- Значение по умолчанию: 30 секунд
- Ограничение ввода: min=5, max=600
- Значение сохраняется автоматически при нажатии "Сохранить"
- Backend использует индивидуальный таймаут модели при анализе
- Если модель не имеет timeout → используется глобальный (90 сек)
- Автоматическая миграция: все существующие модели получают timeout=30

#### 4. Окно добавления новых моделей
- Кнопка "Обновить модели" теперь открывает специальное окно выбора
- Окно показывает все доступные модели из OpenAI API
- Модели, уже добавленные в конфигурацию, исключаются из списка
- Каждая модель отображается с информацией:
  - Display name
  - Model ID
  - Контекст (количество токенов)
  - Чекбокс для выбора
- Пользователь выбирает нужные модели галочками
- Кнопка "Добавить выбранные" отправляет запрос на backend
- После успешного добавления список моделей обновляется
- Окно автоматически закрывается через 1.5 секунды

### Технические детали

**Изменённые файлы**:
- `webapp/utils/markdown_renderer.py` — визуальное выделение суммы в рублях
- `templates/index.html` — перемещение блока ошибок, добавление модального окна
- `static/js/rag-analysis.js` — поле timeout, логика добавления моделей
- `webapp/routes/ai_rag.py` — миграция timeout, новые endpoints, использование timeout

**Новые endpoints**:
- `GET /ai_rag/models/available` — список всех доступных моделей из OpenAI
- `POST /ai_rag/models/add` — добавление выбранных моделей

**Миграция данных**:
- Все модели автоматически получают поле `timeout: 30` при первой загрузке
- Существующие модели не теряют настройки

### Как использовать

**Настройка таймаута**:
1. Открыть "Выбор модели"
2. Найти поле "Таймаут (сек)" для нужной модели
3. Ввести значение (5-600 секунд)
4. Нажать "Сохранить"

**Добавление новых моделей**:
1. Открыть "Выбор модели"
2. Нажать "🔄 Обновить модели"
3. Просмотреть список доступных моделей
4. Отметить галочками нужные модели
5. Нажать "Добавить выбранные"
6. Дождаться подтверждения и автоматического закрытия окна

---

## Примечания

- Изменения совместимы с существующей функциональностью
- Сервер успешно перезапущен на порту 8081 (PID: 25578)
- Нет синтаксических ошибок
- Все задачи выполнены и готовы к тестированию

**Дополнительные улучшения**:
- Добавлено более подробное отображение информации о моделях
- Улучшена UX: пользователь видит только те модели, которые можно добавить
- Защита от дублирования: уже добавленные модели фильтруются автоматически

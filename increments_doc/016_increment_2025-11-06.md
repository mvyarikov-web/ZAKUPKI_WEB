Ответ на “почему таблица chunks пустая?”

Для не‑текстовых форматов (PDF/DOCX/XLSX и т.д.) текущая ветка db-индексации не вызывает экстракторы из document_processor, а пытается читать как обычный текст — результат пустой → чанки не создаются. Это и есть основная причина “пусто”.
Если вы грузили только такие файлы через /build_index или через /upload (без “на лету” извлечения текста), чанков в БД не появлялось.
Что можно сделать дальше

Быстрый MVP: в index_document_to_db определить по расширению и прокинуть извлечение текста через document_processor (у нас есть готовый Indexer._extract_text), а не обычный open(). Это даст чанки для PDF/DOCX/XLSX. Готов подключить минимально, не трогая остальное.
Временно: ограничиться текстовыми форматами (txt, csv) для БД-индексации, а PDF/DOCX держать в “legacy” индексе для поиска. Но у вас уже курс на БД, так что лучше включить извлечение.
Е2Е-проверка (как только сервер поднят):
POST /build_index → лог должен показать “Документ ... проиндексирован: N чанков”.
Проверить в БД: documents.status = 'indexed', chunks.count > 0.
Открыть /view/<relative_path>?token=... — должно отдать собранный текст из чанков.
Если ок, я внедрю извлечение текста в db_indexing для базовых форматов (txt/pdf/docx/xlsx/xls) через документ‑процессор, оставив тихий деградационный режим и минимальные зависимости. Это будет небольшой, но критичный апгрейд, после которого chunks начнёт заполняться для большинства реальных файлов.


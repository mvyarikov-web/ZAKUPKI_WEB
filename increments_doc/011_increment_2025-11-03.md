# Инкремент 011 — Перепроектирование Search API, UI и управления промптами

**Дата:** 2025-11-03  
**Дата и время пуша (MSK):** 2025-11-02 16:05  
**Git commit hash:** `8aae861`

---

## Постановка

1. **Search API (Perplexity) не работал, параметры не сохранялись**
2. **Пользовательские параметры поиска не запоминались после анализа**
3. **Модальное окно управления промптами не показывало превью и не позволяло перезаписывать**
4. **Сообщения об ошибках и успехе исчезали автоматически, что мешало UX**
5. **Не было единого способа отображения статусов поиска и анализа**
6. **Требовалось зафиксировать все изменения и подготовить документацию инкремента**

## Спецификация

### 1. Перепроектирование Perplexity Search API
- Исправлен эндпоинт и логика вызова Search API (модель `perplexity-search-api`)
- Добавлен контракт: параметры поиска (7 полей) сохраняются и восстанавливаются после анализа
- В `models.json` добавлен блок `search_params` для Search API, реализована поддержка request-based pricing (`price_per_1000_requests`)
- В UI (rag-analysis.js, index.html) реализовано отображение и редактирование всех параметров Search API

### 2. Персистентность параметров поиска
- После анализа значения всех полей Search API сохраняются и автоматически подставляются при повторном открытии
- Реализовано сохранение через POST `/ai_rag/models/search_params` и локальное обновление модели

### 3. Модальное управление промптами
- Модалка выбора промпта теперь показывает превью каждого файла
- Добавлена возможность перезаписи существующего промпта с подтверждением
- При сохранении нового промпта предлагается ввести имя файла

### 4. Сообщения: отказ от автоскрытия
- Весь MessageManager переписан: duration по умолчанию 0, сообщения не исчезают сами
- Везде убраны таймеры автоскрытия, добавлена кнопка закрытия
- Сообщения об ошибках/успехе теперь всегда видны до ручного закрытия

### 5. Единый UX для статусов поиска и анализа
---

## Реализация (простыми словами)
- Для всех моделей Sonar добавлен режим поиска: чекбокс "С поиском в интернете" в UI, параметры поиска, отдельная тарификация.
- В models.json теперь есть supports_search, price_per_1000_requests, search_params для каждой Sonar-модели.
- Бэкенд принимает флаг search_enabled, передаёт параметры поиска, явно управляет disable_search для тарификации.
- В результатах анализа добавлен флаг search_used — отражает факт использования поиска для отчёта и расчёта стоимости.

## Примечания
- Вся логика тарификации и UI теперь корректно разделяет режимы "с поиском" и "без поиска" для Sonar.
- Изменения покрывают backend, models.json и UI, протестированы для всех 5 моделей.
- В script.js и rag-analysis.js унифицированы сообщения о статусе поиска, загрузки, анализа
- В index.html добавлены новые области для статусов и прогресса

### 6. Коммит и пуш
- Все изменения закоммичены и запушены (hash: 9b4cd80)
- commit_hash.md обновлён с кратким описанием

## Реализация (простыми словами)

- Исправлен Search API: теперь работает, параметры сохраняются, стоимость считается по запросам
- В модальном окне промптов можно просмотреть содержимое и перезаписать файл
- Сообщения больше не исчезают сами — пользователь всегда видит статус
- Весь UI поиска и анализа стал более прозрачным и дружелюбным
- Все изменения зафиксированы и задокументированы

## Примечания

- Изменения затронули: models.json, rag-analysis.js, ai_rag.py, message-manager.js, script.js, index.html, ai-analysis.js
- Вся документация и интерфейс — на русском
- Тесты и проверки проведены, ошибок не выявлено

✅ models.json:

Удалена модель perplexity-search-api
Для всех sonar-моделей добавлены: supports_search: true, price_per_1000_requests, search_params
default_model изменён на sonar
✅ rag-analysis.js:

Добавлен чекбокс "С поиском в интернете" для sonar-моделей
При включении чекбокса: показываются параметры поиска, тарификация меняется на "за запросы"
При выключении: скрываются параметры, возвращается токеновая тарификация
Обновлены updateRagMetrics() для отображения "Model + Search"
В startAnalysis() передаётся флаг search_enabled и параметры поиска
✅ ai_rag.py и rag_service.py:

Убрана проверка на perplexity-search-api как отдельную модель
Добавлен параметр search_enabled в запросе
Параметры поиска передаются в Chat Completions API
Функция search_and_analyze() теперь принимает search_params
# Приращение 002: Модуль AI-анализа (ChatGPT API)

# Git commit hash (origin/main на момент консолидации)
47f5b793047b8f86bade7f2877a8b97a272e000f

## Постановка

Добавить в программу модуль AI-анализа документов с использованием ChatGPT API, который позволит пользователю:
- Выбирать файлы для анализа через чекбоксы
- Настраивать промпты для анализа
- Отправлять запросы к GPT API
- Получать и сохранять результаты анализа

## Спецификация

### 1. Интерфейс
- Кнопка "Анализ AI" в секции инструментов (справа от остальных кнопок)
- Чекбоксы слева от каждого индексированного файла для выбора файлов для анализа (всегда отображаются для проиндексированных файлов)
- Модальные окна для:
  - Ввода/редактирования промпта
  - Отображения результатов
  - Индикации прогресса
  - Выбора сохранённых промптов

### 2. Функциональность
- Выбор файлов через чекбоксы (только для индексированных файлов)
- Управление промптами:
  - Загрузка последнего использованного промпта
  - Сохранение промпта в файл
  - Загрузка промпта из файла
  - Список сохранённых промптов
- Оптимизация текста перед отправкой
- Ограничение размера запроса (4096 символов)
- Асинхронный запуск анализа (threading на старте; Celery — опционально)
- Ограничение размера запроса (4096 символов)
- Отправка запроса к ChatGPT API
- Отображение результатов
- Сохранение результатов:
  - Копирование в буфер обмена
  - Сохранение в текстовый файл

### 3. API Endpoints
- `POST /ai_analysis/analyze` — выполнить AI-анализ выбранных файлов
- `POST /ai_analysis/optimize_text` — оптимизировать текст
- `POST /ai_analysis/prompts/save` — сохранить промпт
- `GET /ai_analysis/prompts/load/<filename>` — загрузить промпт
- `GET /ai_analysis/prompts/last` — получить последний промпт
- `GET /ai_analysis/prompts/list` — список сохранённых промптов
- `POST /ai_analyze` — упрощённая точка для старта анализа выбранных файлов
- `GET /ai_status/<task_id>` — статус и результат фоновой задачи анализа

### 4. Обработка ошибок и безопасность
- Проверка наличия и валидности API-ключа (`OPENAI_API_KEY`)
- Валидация размера запроса (4096 символов)
- Проверка, что файлы лежат в `uploads/` и не превышают лимит
- Ограничение частоты (не более одной активной задачи на пользователя)
- Проверка наличия API ключа
- Валидация размера запроса
- Обработка сетевых ошибок
- Логирование всех операций

## Реализация (простыми словами)

Реализован полный модуль AI анализа документов:

**Backend:**
- Создан сервис `GPTAnalysisService` для работы с OpenAI API
- Создан менеджер промптов `PromptManager` для управления сохранёнными промптами
- Реализованы API endpoints (см. список выше), добавлены упрощённые `/ai_analyze` и `/ai_status/<task_id>`
- Асинхронная обработка через threading (без блокировки основного потока)
- Добавлена конфигурация для OpenAI API ключа (`OPENAI_API_KEY`)

**Frontend:**
- Добавлена кнопка "Анализ AI" в панель инструментов (активна при выборе хотя бы одного файла)
- Добавлены чекбоксы для выбора файлов (отображаются только для индексированных файлов)
- Создано модальное окно для настройки промпта с функциями:
  - Редактирование промпта
  - Сохранение/загрузка промптов
  - Оптимизация текста
  - Отображение информации о выбранных файлах
- Создано модальное окно для отображения результатов с функциями:
  - Просмотр/редактирование результата
  - Копирование в буфер обмена
  - Сохранение в файл
- Добавлен индикатор прогресса во время выполнения запроса
- Реализована валидация и обработка ошибок

**Инфраструктура:**
- Создана папка `PROMPT` для хранения промптов (создаётся автоматически)
- Добавлена зависимость `requests` для работы с HTTP API
- Зарегистрирован blueprint `ai_analysis_bp` в приложении
- Добавлены CSS стили для новых элементов интерфейса
- Статусы задач и результаты сохраняются в `index/analysis_result.json`

**Особенности:**
- API ключ настраивается через переменную окружения `OPENAI_API_KEY` или конфигурацию
- Промпт по умолчанию: "Проанализируй следующие документы и предоставь краткую сводку:"
- Максимальный размер запроса: 4096 символов (настраивается)
- Автоматическая оптимизация текста (удаление лишних пробелов и переносов)
- Все операции логируются
- Добавлено ограничение частоты (rate limit) на анализ

## Дата и время пуша (MSK)
19.10.2025 21:15

## Git commit hash (локальный)
8c25996

#


## Примечания

Для работы модуля необходимо:
1. Установить API ключ OpenAI через переменную окружения:
   ```bash
   export OPENAI_API_KEY='your-api-key-here'
   ```

2. Файлы должны быть проиндексированы (иметь метаданные о количестве символов), чтобы чекбоксы появились рядом с ними

3. По умолчанию используется модель `gpt-3.5-turbo` с максимум 150 токенами в ответе

Модуль полностью независим от существующей логики поиска и индексации, работает параллельно с ними.

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        .admin-section {
            background: white;
            margin-bottom: 20px;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .admin-section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        .stat-card.warning {
            border-left-color: #f39c12;
        }
        .stat-card.danger {
            border-left-color: #e74c3c;
        }
        .stat-label {
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .admin-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .btn-admin {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn-admin.primary {
            background: #3498db;
            color: white;
        }
        .btn-admin.primary:hover {
            background: #2980b9;
        }
        .btn-admin.danger {
            background: #e74c3c;
            color: white;
        }
        .btn-admin.danger:hover {
            background: #c0392b;
        }
        .btn-admin.success {
            background: #27ae60;
            color: white;
        }
        .btn-admin.success:hover {
            background: #229954;
        }
        .btn-admin.warning {
            background: #f39c12;
            color: white;
        }
        .btn-admin.warning:hover {
            background: #e67e22;
        }
        .switch-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #27ae60;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .log-area {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 3px solid #3498db;
            padding-left: 10px;
        }
        .log-entry.info { border-left-color: #3498db; }
        .log-entry.warning { border-left-color: #f39c12; }
        .log-entry.error { border-left-color: #e74c3c; }
        .candidates-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .candidates-table th,
        .candidates-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        .candidates-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
        }
        .candidates-table tr:hover {
            background: #f8f9fa;
        }
        .message-box {
            padding: 12px 15px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
        }
        .message-box.info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #2196f3;
        }
        .message-box.success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #4caf50;
        }
        .message-box.error {
            background: #ffebee;
            color: #d32f2f;
            border-left: 4px solid #f44336;
        }
        .message-box.warning {
            background: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #ff9800;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>
            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</p>
            <a href="/" class="btn btn-secondary" style="margin-top: 15px;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
        </header>

        <main>
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ -->
            <div class="admin-section">
                <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞</h2>
                <div class="stat-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-label">–í—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</div>
                        <div class="stat-value" id="statTotalDocs">‚Äî</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–í–∏–¥–∏–º—ã–µ</div>
                        <div class="stat-value" id="statVisibleDocs">‚Äî</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-label">–£–¥–∞–ª—ë–Ω–Ω—ã–µ (–º—è–≥–∫–æ)</div>
                        <div class="stat-value" id="statDeletedDocs">‚Äî</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–í—Å–µ–≥–æ —á–∞–Ω–∫–æ–≤</div>
                        <div class="stat-value" id="statTotalChunks">‚Äî</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                        <div class="stat-value" id="statTotalUsers">‚Äî</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ß–∞–Ω–∫–æ–≤ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç (—Å—Ä.)</div>
                        <div class="stat-value" id="statAvgChunks">‚Äî</div>
                    </div>
                </div>
                <div class="admin-controls">
                    <button class="btn-admin primary" onclick="loadStats()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
                </div>
                <div id="statsMessage" class="message-box"></div>
            </div>

            <!-- –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ -->
            <div class="admin-section">
                <h2>üîÅ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞</h2>
                <p style="color:#7f8c8d; margin-bottom:12px;">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—É—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É —Å–µ—Ä–≤–µ—Ä–∞: –ø–æ—Ä—Ç –±—É–¥–µ—Ç –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω, –∑–∞—Ç–µ–º —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –≤–Ω–æ–≤—å —É–∫–∞–∑–∞–Ω–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π.</p>
                <div class="admin-controls" style="gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                    <div>
                        <div class="stat-label">–ü–æ—Ä—Ç</div>
                        <input id="restartPort" type="number" min="1" max="65535" value="5000" style="padding:8px; width:140px;">
                    </div>
                    <div style="flex:1; min-width: 260px;">
                        <div class="stat-label">–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞</div>
                        <input id="restartCommand" type="text" value=".venv/bin/python app.py" style="padding:8px; width:100%;">
                    </div>
                    <div>
                        <div class="stat-label">–û–∂–∏–¥–∞–Ω–∏–µ (—Å–µ–∫)</div>
                        <input id="restartWait" type="number" min="0" step="0.1" value="2.5" style="padding:8px; width:120px;">
                    </div>
                    <button class="btn-admin warning" onclick="restartServer()">üîÅ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
                </div>
                <div id="restartMessage" class="message-box"></div>
            </div>

            <!-- –û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö -->
            <div class="admin-section">
                <h2>üßπ –û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h2>
                <p style="color:#7f8c8d; margin-bottom:12px;">–í—ã –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—ã–±–æ—Ä–∞ —Ç–∞–±–ª–∏—Ü –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å TRUNCATE —Å —Å–±—Ä–æ—Å–æ–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–∞–±–ª–∏—Ü–∞ prompts —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.</p>
                <div class="admin-controls">
                    <a href="/admin/db/cleanup" class="btn-admin danger" target="_blank">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—á–∏—Å—Ç–∫–µ –ë–î</a>
                </div>
            </div>

            <!-- Garbage Collection -->
            <div class="admin-section">
                <h2>üóëÔ∏è Garbage Collection</h2>
                <p style="color: #7f8c8d; margin-bottom: 15px;">
                    –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∏ —Ä–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ retention score
                </p>
                <div class="admin-controls">
                    <button class="btn-admin warning" onclick="loadCandidates()">üëÄ –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ</button>
                    <button class="btn-admin primary" onclick="runGC(true)">üß™ –¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–≥–æ–Ω (dry-run)</button>
                    <button class="btn-admin danger" onclick="runGC(false)">‚ö†Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å GC (—Ä–µ–∞–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ)</button>
                </div>
                <div id="gcMessage" class="message-box"></div>
                <div id="candidatesContainer" style="display: none; margin-top: 20px;">
                    <h3>–ö–∞–Ω–¥–∏–¥–∞—Ç—ã –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ</h3>
                    <table class="candidates-table" id="candidatesTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–§–∞–π–ª</th>
                                <th>–í–ª–∞–¥–µ–ª–µ—Ü</th>
                                <th>Retention Score</th>
                                <th>–û–±—Ä–∞—â–µ–Ω–∏–π</th>
                                <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ—Å—Ç—É–ø</th>
                            </tr>
                        </thead>
                        <tbody id="candidatesBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–≥—Ä—É–∑–æ–∫ -->
            <div class="admin-section">
                <h2>üö® –≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
                <p style="color: #7f8c8d; margin-bottom: 15px;">
                    –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–≥—Ä—É–∑–æ–∫ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö (–ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –∫–≤–æ—Ç—ã, –∞—Ç–∞–∫–∞ –∏ —Ç.–¥.)
                </p>
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="uploadsToggle" onchange="toggleUploads()">
                        <span class="slider"></span>
                    </label>
                    <span id="uploadsStatus">–ó–∞–≥—Ä—É–∑–∫–∏: –ø—Ä–æ–≤–µ—Ä–∫–∞...</span>
                </div>
                <div id="uploadsMessage" class="message-box"></div>
            </div>

            <!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ GC -->
            <div class="admin-section">
                <h2>‚è∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π Garbage Collection</h2>
                <p style="color: #7f8c8d; margin-bottom: 15px;">
                    –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ GC –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 MSK)
                </p>
                
                <div class="stat-grid" style="margin-bottom: 20px;">
                    <div class="stat-card" id="schedulerStatusCard">
                        <div class="stat-label">–°—Ç–∞—Ç—É—Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞</div>
                        <div class="stat-value" id="schedulerRunningStatus">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                    <div class="stat-card" id="schedulerNextRunCard">
                        <div class="stat-label">–°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫</div>
                        <div class="stat-value" id="schedulerNextRun" style="font-size: 16px;">‚Äî</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
                        <div class="stat-value" id="schedulerConfig" style="font-size: 16px;">‚Äî</div>
                    </div>
                </div>

                <div class="switch-container" style="margin-bottom: 15px;">
                    <label class="switch">
                        <input type="checkbox" id="schedulerToggle" onchange="toggleScheduler()">
                        <span class="slider"></span>
                    </label>
                    <span id="schedulerToggleLabel">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π GC: –ø—Ä–æ–≤–µ—Ä–∫–∞...</span>
                </div>

                <div id="schedulerMessage" class="message-box"></div>
            </div>

            <!-- –ê—É–¥–∏—Ç –ª–æ–≥–æ–≤ -->
            <div class="admin-section">
                <h2>üìù –õ–æ–≥–∏ –∞—É–¥–∏—Ç–∞</h2>
                <p style="color: #7f8c8d; margin-bottom: 15px;">
                    –ü–æ—Å–ª–µ–¥–Ω–∏–µ 50 –∑–∞–ø–∏—Å–µ–π –æ —Ä–∞–±–æ—Ç–µ GC –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º
                </p>
                <div class="admin-controls">
                    <button class="btn-admin primary" onclick="loadAuditLog()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏</button>
                </div>
                <div class="log-area" id="auditLog">
                    <div class="log-entry info">–õ–æ–≥–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        let uploadsEnabled = true;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            checkUploadsStatus();
            loadAuditLog();
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `message-box ${type}`;
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 5000);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function loadStats() {
            try {
                showMessage('statsMessage', '–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...', 'info');
                const response = await fetch('/admin/storage/stats');
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
                
                const data = await response.json();
                document.getElementById('statTotalDocs').textContent = data.total_documents || 0;
                document.getElementById('statVisibleDocs').textContent = data.visible_documents || 0;
                document.getElementById('statDeletedDocs').textContent = data.deleted_documents || 0;
                document.getElementById('statTotalChunks').textContent = data.total_chunks || 0;
                document.getElementById('statTotalUsers').textContent = data.total_users || 0;
                document.getElementById('statAvgChunks').textContent = 
                    data.avg_chunks_per_document ? data.avg_chunks_per_document.toFixed(1) : '0.0';
                
                showMessage('statsMessage', '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                showMessage('statsMessage', '–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
        async function restartServer() {
            if (!confirm('–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä–≤–µ—Ä? –¢–µ–∫—É—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω–æ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.')) {
                return;
            }
            const port = parseInt(document.getElementById('restartPort').value || '5000', 10);
            const command = document.getElementById('restartCommand').value || '.venv/bin/python app.py';
            const wait = parseFloat(document.getElementById('restartWait').value || '2.5');
            try {
                showMessage('restartMessage', '–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω...', 'info');
                const resp = await fetch('/admin/server/restart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ port: port, command: command, wait: wait })
                });
                if (!resp.ok) {
                    const txt = await resp.text();
                    throw new Error('HTTP ' + resp.status + ': ' + txt);
                }
                const data = await resp.json();
                showMessage('restartMessage', data.message || '–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞', 'success');
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:', e);
                showMessage('restartMessage', '–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
        async function loadCandidates() {
            try {
                showMessage('gcMessage', '–ü–æ–∏—Å–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ...', 'info');
                const response = await fetch('/admin/gc/candidates?threshold=-1.0&limit=100');
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤');
                
                const data = await response.json();
                const tbody = document.getElementById('candidatesBody');
                tbody.innerHTML = '';
                
                if (data.candidates && data.candidates.length > 0) {
                    data.candidates.forEach(candidate => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${candidate.document_id}</td>
                            <td title="${candidate.file_path}">${candidate.file_path.substring(0, 40)}...</td>
                            <td>${candidate.owner_id}</td>
                            <td>${candidate.retention_score.toFixed(2)}</td>
                            <td>${candidate.access_count || 0}</td>
                            <td>${candidate.last_accessed_at ? new Date(candidate.last_accessed_at).toLocaleDateString('ru') : '–Ω–∏–∫–æ–≥–¥–∞'}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    document.getElementById('candidatesContainer').style.display = 'block';
                    showMessage('gcMessage', `–ù–∞–π–¥–µ–Ω–æ ${data.candidates.length} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ`, 'success');
                } else {
                    document.getElementById('candidatesContainer').style.display = 'none';
                    showMessage('gcMessage', '–ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'info');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:', error);
                showMessage('gcMessage', '–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // –ó–∞–ø—É—Å–∫ GC
        async function runGC(dryRun) {
            if (!dryRun && !confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ –ë–î (–º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ).')) {
                return;
            }
            
            try {
                const mode = dryRun ? '—Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º' : '—Ä–µ–∞–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ';
                showMessage('gcMessage', `–ó–∞–ø—É—Å–∫ GC (${mode})...`, 'info');
                
                const response = await fetch('/admin/gc/run', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        dry_run: dryRun,
                        threshold: -1.0,
                        batch_size: 100
                    })
                });
                
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è GC');
                
                const data = await response.json();
                const msg = `GC –∑–∞–≤–µ—Ä—à—ë–Ω. –£–¥–∞–ª–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: ${data.deleted_count}, —á–∞–Ω–∫–æ–≤: ${data.deleted_chunks}. ` +
                           `–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–æ –º–µ—Å—Ç–∞: ${(data.freed_space_bytes / 1024 / 1024).toFixed(2)} –ú–ë. ` +
                           `–í—Ä–µ–º—è: ${data.execution_time_seconds.toFixed(2)} —Å–µ–∫.`;
                showMessage('gcMessage', msg, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                await loadStats();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ GC:', error);
                showMessage('gcMessage', '–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–≥—Ä—É–∑–æ–∫
        async function checkUploadsStatus() {
            try {
                const response = await fetch('/admin/config');
                if (response.ok) {
                    const data = await response.json();
                    uploadsEnabled = !data.uploads_disabled;
                    updateUploadsUI();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–≥—Ä—É–∑–æ–∫:', error);
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–æ–∫
        async function toggleUploads() {
            const toggle = document.getElementById('uploadsToggle');
            const newState = toggle.checked;
            
            try {
                showMessage('uploadsMessage', '–ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫...', 'info');
                const response = await fetch('/admin/uploads/toggle', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({disable: !newState})
                });
                
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫');
                
                const data = await response.json();
                uploadsEnabled = !data.uploads_disabled;
                updateUploadsUI();
                
                const msg = uploadsEnabled ? '–ó–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã' : '–ó–∞–≥—Ä—É–∑–∫–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã';
                showMessage('uploadsMessage', msg, 'success');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–æ–∫:', error);
                toggle.checked = uploadsEnabled;
                showMessage('uploadsMessage', '–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–≥—Ä—É–∑–æ–∫
        function updateUploadsUI() {
            const toggle = document.getElementById('uploadsToggle');
            const status = document.getElementById('uploadsStatus');
            toggle.checked = uploadsEnabled;
            status.textContent = uploadsEnabled ? 
                '‚úÖ –ó–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã' : 
                'üö´ –ó–∞–≥—Ä—É–∑–∫–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã';
            status.style.color = uploadsEnabled ? '#27ae60' : '#e74c3c';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤ –∞—É–¥–∏—Ç–∞
        async function loadAuditLog() {
            try {
                const response = await fetch('/admin/audit_log?limit=50');
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤');
                
                const data = await response.json();
                const logArea = document.getElementById('auditLog');
                logArea.innerHTML = '';
                
                if (data.logs && data.logs.length > 0) {
                    data.logs.forEach(log => {
                        const entry = document.createElement('div');
                        entry.className = `log-entry ${log.level || 'info'}`;
                        const timestamp = new Date(log.timestamp).toLocaleString('ru');
                        entry.textContent = `[${timestamp}] ${log.message}`;
                        logArea.appendChild(entry);
                    });
                } else {
                    logArea.innerHTML = '<div class="log-entry info">–õ–æ–≥–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:', error);
                const logArea = document.getElementById('auditLog');
                logArea.innerHTML = `<div class="log-entry error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
        async function checkSchedulerStatus() {
            try {
                const response = await fetch('/admin/scheduler/status');
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                
                const data = await response.json();
                updateSchedulerUI(data);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞:', error);
                document.getElementById('schedulerRunningStatus').textContent = '‚ùå –û—à–∏–±–∫–∞';
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
        function updateSchedulerUI(status) {
            const runningStatus = document.getElementById('schedulerRunningStatus');
            const nextRun = document.getElementById('schedulerNextRun');
            const config = document.getElementById('schedulerConfig');
            const toggle = document.getElementById('schedulerToggle');
            const label = document.getElementById('schedulerToggleLabel');
            const statusCard = document.getElementById('schedulerStatusCard');
            const nextRunCard = document.getElementById('schedulerNextRunCard');
            
            // –°—Ç–∞—Ç—É—Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
            if (status.running && status.gc_job_scheduled) {
                runningStatus.textContent = '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω';
                runningStatus.style.color = '#27ae60';
                statusCard.style.borderLeftColor = '#27ae60';
            } else if (status.running) {
                runningStatus.textContent = '‚ö†Ô∏è –ó–∞–ø—É—â–µ–Ω (–∑–∞–¥–∞—á–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞)';
                runningStatus.style.color = '#f39c12';
                statusCard.style.borderLeftColor = '#f39c12';
            } else {
                runningStatus.textContent = '‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                runningStatus.style.color = '#95a5a6';
                statusCard.style.borderLeftColor = '#95a5a6';
            }
            
            // –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫
            if (status.next_run_time) {
                const nextDate = new Date(status.next_run_time);
                nextRun.textContent = nextDate.toLocaleString('ru', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                nextRunCard.style.borderLeftColor = '#3498db';
            } else {
                nextRun.textContent = '‚Äî';
                nextRunCard.style.borderLeftColor = '#ecf0f1';
            }
            
            // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
            if (status.config) {
                config.textContent = `–ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ ${status.config.hour}:00 MSK`;
            }
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å
            toggle.checked = status.gc_job_scheduled;
            label.textContent = status.gc_job_scheduled ? 
                '‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π GC –≤–∫–ª—é—á—ë–Ω' : 
                '‚è∏Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π GC –≤—ã–∫–ª—é—á–µ–Ω';
            label.style.color = status.gc_job_scheduled ? '#27ae60' : '#7f8c8d';
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
        async function toggleScheduler() {
            const toggle = document.getElementById('schedulerToggle');
            const newState = toggle.checked;
            
            try {
                showMessage('schedulerMessage', '–ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞...', 'info');
                const response = await fetch('/admin/scheduler/toggle', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({enabled: newState})
                });
                
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫');
                
                const data = await response.json();
                updateSchedulerUI(data.status);
                
                const msg = newState ? 
                    '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π GC –≤–∫–ª—é—á—ë–Ω' : 
                    '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π GC –≤—ã–∫–ª—é—á–µ–Ω';
                showMessage('schedulerMessage', msg, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                setTimeout(checkSchedulerStatus, 1000);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞:', error);
                toggle.checked = !newState;
                showMessage('schedulerMessage', '–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
            checkSchedulerStatus();
        });
    </script>
</body>
</html>

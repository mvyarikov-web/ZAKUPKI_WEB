<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç—á—ë—Ç –ø–æ —Ç–æ–∫–µ–Ω–∞–º</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        .token-report-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .report-header h1 {
            margin: 0;
            color: #1f2937;
        }
        
        .period-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 6px;
        }
        
        .period-selector label {
            font-weight: 600;
            color: #374151;
        }
        
        .period-selector select,
        .period-selector input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .period-selector button {
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .period-selector button:hover {
            background: #2563eb;
        }
        
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-card.green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .stat-card.blue {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            margin: 0;
        }
        
        .tokens-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .tokens-table th,
        .tokens-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .tokens-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
        }
        
        .tokens-table tr:hover {
            background: #f9fafb;
        }
        
        .tokens-table td {
            color: #6b7280;
        }
        
        .model-name {
            font-weight: 600;
            color: #1f2937;
        }
        
        .token-count {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .custom-period {
            display: none;
            gap: 10px;
            align-items: center;
        }
        
        .custom-period.active {
            display: flex;
        }
    </style>
</head>
<body>
    <div class="token-report-container">
        <div class="report-header">
            <h1>üìä –û—Ç—á—ë—Ç –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Ç–æ–∫–µ–Ω–æ–≤</h1>
            <a href="/" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</a>
        </div>
        
        <div class="period-selector">
            <label>–ü–µ—Ä–∏–æ–¥:</label>
            <select id="periodType">
                <option value="all_time">–í—Å—ë –≤—Ä–µ–º—è</option>
                <option value="current_month">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</option>
                <option value="custom">–í—ã–±—Ä–∞—Ç—å –ø–µ—Ä–∏–æ–¥</option>
            </select>
            
            <div id="customPeriod" class="custom-period">
                <label>–°:</label>
                <input type="date" id="startDate">
                <label>–ü–æ:</label>
                <input type="date" id="endDate">
            </div>
            
            <button onclick="loadStats()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        
        <div class="stats-summary" id="statsSummary">
            <div class="stat-card">
                <h3>–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</h3>
                <div class="value" id="totalRequests">‚Äî</div>
            </div>
            <div class="stat-card green">
                <h3>–í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤</h3>
                <div class="value" id="totalTokens">‚Äî</div>
            </div>
            <div class="stat-card blue">
                <h3>–ú–æ–¥–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</h3>
                <div class="value" id="totalModels">‚Äî</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <h3>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</h3>
                <div class="value" id="totalCost">‚Äî</div>
                <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;" id="totalCostUSD">‚Äî</div>
            </div>
        </div>
        
        <div id="tableContainer">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
    </div>
    
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã —Ç–∏–ø–∞ –ø–µ—Ä–∏–æ–¥–∞
            document.getElementById('periodType').addEventListener('change', (e) => {
                const customPeriod = document.getElementById('customPeriod');
                if (e.target.value === 'custom') {
                    customPeriod.classList.add('active');
                } else {
                    customPeriod.classList.remove('active');
                }
            });
        });
        
        async function loadStats() {
            const periodType = document.getElementById('periodType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            let url = '/ai_rag/token_stats?';
            if (periodType === 'custom') {
                if (startDate) url += `start_date=${startDate}&`;
                if (endDate) url += `end_date=${endDate}&`;
            } else {
                url += `period=${periodType}`;
            }
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    renderStats(data);
                } else {
                    document.getElementById('tableContainer').innerHTML = 
                        `<div class="no-data">–û—à–∏–±–∫–∞: ${data.error}</div>`;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                document.getElementById('tableContainer').innerHTML = 
                    '<div class="no-data">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
            }
        }
        
        function renderStats(data) {
            const models = data.models || [];
            
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            let totalRequests = 0;
            let totalTokens = 0;
            let totalCostRub = 0;
            let totalCostUsd = 0;
            
            models.forEach(model => {
                totalRequests += model.total_requests || 0;
                totalTokens += model.total_tokens || 0;
                totalCostRub += model.total_cost_rub || 0;
                totalCostUsd += model.total_cost_usd || 0;
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
            document.getElementById('totalRequests').textContent = totalRequests.toLocaleString('ru-RU');
            document.getElementById('totalTokens').textContent = totalTokens.toLocaleString('ru-RU');
            document.getElementById('totalModels').textContent = models.length;
            document.getElementById('totalCost').textContent = totalCostRub.toFixed(2) + ' ‚ÇΩ';
            document.getElementById('totalCostUSD').textContent = '$' + totalCostUsd.toFixed(4);
            
            // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É
            if (models.length === 0) {
                document.getElementById('tableContainer').innerHTML = 
                    '<div class="no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>';
                return;
            }
            
            let tableHtml = `
                <table class="tokens-table">
                    <thead>
                        <tr>
                            <th>–ú–æ–¥–µ–ª—å</th>
                            <th>–ó–∞–ø—Ä–æ—Å–æ–≤</th>
                            <th>–í—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã</th>
                            <th>–í—ã—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã</th>
                            <th>–í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤</th>
                            <th>–°—Ç–æ–∏–º–æ—Å—Ç—å ‚ÇΩ</th>
                            <th>–°—Ä–µ–¥–Ω—è—è ‚ÇΩ</th>
                            <th>–°—Ä. –≤—Ä–µ–º—è (—Å–µ–∫)</th>
                            <th>–ü–µ—Ä–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</th>
                            <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            models.forEach(model => {
                const firstUsed = new Date(model.first_used).toLocaleString('ru-RU');
                const lastUsed = new Date(model.last_used).toLocaleString('ru-RU');
                const costRub = (model.total_cost_rub || 0).toFixed(2);
                const avgCostRub = (model.avg_cost_rub || 0).toFixed(4);
                const avgDuration = (model.avg_duration_seconds || 0).toFixed(2);
                
                tableHtml += `
                    <tr>
                        <td class="model-name">${escapeHtml(model.model_id)}</td>
                        <td>${model.total_requests.toLocaleString('ru-RU')}</td>
                        <td class="token-count">${model.prompt_tokens.toLocaleString('ru-RU')}</td>
                        <td class="token-count">${model.completion_tokens.toLocaleString('ru-RU')}</td>
                        <td class="token-count"><strong>${model.total_tokens.toLocaleString('ru-RU')}</strong></td>
                        <td style="color: #d97706; font-weight: 600;">${costRub} ‚ÇΩ</td>
                        <td style="color: #059669;">${avgCostRub} ‚ÇΩ</td>
                        <td style="color: #2563eb;">${avgDuration}s</td>
                        <td>${firstUsed}</td>
                        <td>${lastUsed}</td>
                    </tr>
                `;
            });
            
            tableHtml += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('tableContainer').innerHTML = tableHtml;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

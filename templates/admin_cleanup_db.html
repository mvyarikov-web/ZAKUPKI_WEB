<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Очистка БД</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
</head>
<body>
<div class="container" style="max-width: 960px;">
  <h2>Очистка базы данных</h2>
  <p class="text-muted">Отметьте таблицы для очистки. Внимание: операция безвозвратна. Используется TRUNCATE ... RESTART IDENTITY CASCADE.</p>

  <div class="mb-3">
    <label><input type="checkbox" id="preservePrompts" checked> Сохранить таблицу prompts</label>
  </div>

  <div id="tablesBlock" class="card">
    <div class="card-header">Таблицы (public)</div>
    <div class="list-group list-group-flush" id="tablesList">
      <div class="list-group-item">Загрузка списка таблиц…</div>
    </div>
  </div>

  <div class="mt-3">
    <button id="runCleanup" class="btn btn-danger">Очистить выбранные</button>
  </div>

  <div class="mt-4" id="resultBlock" style="display:none;">
    <h5>Результат</h5>
    <pre id="resultPre" style="white-space: pre-wrap;"></pre>
  </div>
</div>

<script src="{{ url_for('static', filename='js/auth.js') }}"></script>
<script>
(function persistTokenFromQuery(){
  try {
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    if (token && typeof setAuthToken === 'function') {
      setAuthToken(token);
    }
  } catch(_) {}
})();
(async function() {
  const listEl = document.getElementById('tablesList');
  const preserveEl = document.getElementById('preservePrompts');
  const resultBlock = document.getElementById('resultBlock');
  const resultPre = document.getElementById('resultPre');

  function renderTables(tables) {
    listEl.innerHTML = '';
    tables.forEach(t => {
      const id = `table_${t.name}`;
      const item = document.createElement('label');
      item.className = 'list-group-item d-flex justify-content-between align-items-center';
      const left = document.createElement('div');
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = t.name;
      cb.id = id;
      cb.disabled = t.protected === true; // спец. таблицы защитим
      left.appendChild(cb);
      const span = document.createElement('span');
      span.textContent = ' ' + t.name;
      left.appendChild(span);

      const right = document.createElement('small');
      right.className = 'text-muted';
      right.textContent = (t.rows === null || t.rows === undefined) ? 'строк: —' : `строк: ${t.rows}`;

      item.appendChild(left);
      item.appendChild(right);
      listEl.appendChild(item);
    });
  }

  async function loadTables() {
    try {
      const resp = await fetch('/admin/db/tables');
      const data = await resp.json();
      if (data.error) throw new Error(data.error);
      renderTables(data.tables || []);
    } catch (e) {
      listEl.innerHTML = `<div class="list-group-item text-danger">Ошибка загрузки списка таблиц: ${e.message}</div>`;
    }
  }

  document.getElementById('runCleanup').addEventListener('click', async () => {
    const checked = Array.from(listEl.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
    if (checked.length === 0) {
      alert('Выберите хотя бы одну таблицу');
      return;
    }
    if (!confirm('Вы уверены? Будет выполнен TRUNCATE выбранных таблиц.')) {
      return;
    }
    try {
      const resp = await fetch('/admin/db/cleanup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tables: checked, preserve_prompts: preserveEl.checked })
      });
      const data = await resp.json();
      resultBlock.style.display = 'block';
      resultPre.textContent = JSON.stringify(data, null, 2);
      if (!data.error) {
        // Перезагрузим список (кол-во строк изменится)
        await loadTables();
      }
    } catch (e) {
      resultBlock.style.display = 'block';
      resultPre.textContent = `Ошибка: ${e.message}`;
    }
  });

  await loadTables();
})();
</script>
</body>
</html>

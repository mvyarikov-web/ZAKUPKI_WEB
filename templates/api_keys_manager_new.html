<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –∫–ª—é—á–∞–º–∏</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        .keys-manager-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .header h1 {
            margin: 0;
            color: #1f2937;
        }
        
        /* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞ */
        .add-key-form {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }
        
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group input[type="text"] {
            font-family: 'Courier New', monospace;
        }
        
        /* –¢–∞–±–ª–∏—Ü–∞ –∫–ª—é—á–µ–π */
        .keys-table-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .table-header h2 {
            margin: 0;
            color: #1f2937;
            font-size: 18px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 12px;
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
            color: #374151;
            font-size: 13px;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }
        
        tbody tr:hover {
            background: #f9fafb;
        }
        
        .key-cell {
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-badge.valid {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-badge.invalid {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-badge.not_validated {
            background: #fef3c7;
            color: #92400e;
        }
        
        .primary-radio {
            cursor: pointer;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f4f6;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .message {
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .message.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .message.error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="keys-manager-container">
        <div class="header">
            <h1>üîë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –∫–ª—é—á–∞–º–∏</h1>
            <button onclick="window.close()" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
        
        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞ -->
        <div class="add-key-form">
            <h2 style="margin: 0 0 15px 0; font-size: 18px; color: #1f2937;">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á</h2>
            
            <div class="form-row">
                <div class="form-group" style="flex: 0 0 200px;">
                    <label for="providerSelect">–ü—Ä–æ–≤–∞–π–¥–µ—Ä</label>
                        <select id="providerSelect" class="form-select">
                            <option value="openai">OpenAI</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="perplexity">Perplexity</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="apiKeyInput">API –ö–ª—é—á</label>
                    <input 
                        type="text" 
                        id="apiKeyInput" 
                        placeholder="sk-... –∏–ª–∏ pplx-..."
                        autocomplete="off"
                        oninput="autoDetectProvider()"
                    >
                </div>
                
                <div style="flex: 0 0 auto;">
                    <button class="btn btn-primary" onclick="addKey()" style="margin: 0;">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á
                    </button>
                </div>
            </div>
            
            <div id="addKeyMessage"></div>
        </div>
        
        <!-- –¢–∞–±–ª–∏—Ü–∞ –∫–ª—é—á–µ–π -->
        <div class="keys-table-container">
            <div id="refreshMessage" style="margin-bottom: 15px;"></div>
            
            <div class="table-header">
                <h2>–°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="refreshAllKeys()" id="refreshKeysBtn">
                        üîÑ –ê–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª—é—á–µ–π
                    </button>
                    <button class="btn btn-secondary" onclick="toggleAllKeysVisibility()" id="toggleKeysBtn">
                        üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–ª—é—á–∏
                    </button>
                </div>
            </div>
            
            <div id="keysTableContainer">
                <div class="empty-state">
                    <div class="loading"></div>
                    <div style="margin-top: 10px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let allKeys = [];
        let showFullKeys = false;
        let usedModels = [];
        let expandedModelsRows = new Set();
        
        // –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É –∫–ª—é—á–∞
        function autoDetectProvider() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const providerSelect = document.getElementById('providerSelect');
            
            if (apiKey.startsWith('pplx-')) {
                providerSelect.value = 'perplexity';
            } else if (apiKey.startsWith('sk-')) {
                // sk- –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–∞–∫ OpenAI, —Ç–∞–∫ –∏ DeepSeek, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä
                // –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é OpenAI –µ—Å–ª–∏ –Ω–µ –±—ã–ª –≤—ã–±—Ä–∞–Ω
                if (providerSelect.value !== 'deepseek') {
                    providerSelect.value = 'openai';
                }
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            loadUsedModels();
            loadKeys();
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(loadKeys, 30000);
        });
        
        async function loadUsedModels() {
            try {
                const response = await fetch('/api_keys/used_models');
                const data = await response.json();
                if (data.success) {
                    usedModels = data.models || [];
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –º–æ–¥–µ–ª–µ–π:', error);
            }
        }
        
        async function loadKeys() {
            try {
                const response = await fetch('/api_keys/list_all');
                const data = await response.json();
                
                if (data.success) {
                    allKeys = data.keys || [];
                    renderKeysTable();
                } else {
                    showTableError(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª—é—á–µ–π');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª—é—á–µ–π:', error);
                showTableError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }
        
        function renderKeysTable() {
            const container = document.getElementById('keysTableContainer');
            
            if (allKeys.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px;">üîë</div>
                        <div style="margin-top: 10px;">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π</div>
                        <div style="margin-top: 5px; font-size: 12px;">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –∫–ª—é—á —Å –ø–æ–º–æ—â—å—é —Ñ–æ—Ä–º—ã –≤—ã—à–µ</div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>–ü—Ä–æ–≤–∞–π–¥–µ—Ä</th>
                            <th>API –ö–ª—é—á</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ú–æ–¥–µ–ª–∏</th>
                            <th style="text-align: center;">–û—Å–Ω–æ–≤–Ω–æ–π</th>
                            <th style="text-align: center;">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            allKeys.forEach((key, index) => {
                const displayKey = showFullKeys ? key.api_key : maskKey(key.api_key);
                const providerNames = {
                    'openai': 'OpenAI',
                    'deepseek': 'DeepSeek',
                    'perplexity': 'Perplexity'
                };
                const providerName = providerNames[key.provider] || key.provider.charAt(0).toUpperCase() + key.provider.slice(1);
                const rowId = `key-row-${index}`;
                const isExpanded = expandedModelsRows.has(rowId);
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π
                let modelsDisplay = '';
                if (key.available_models && key.available_models.length > 0) {
                    // –§–∏–ª—å—Ç—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –º–æ–¥–µ–ª–∏
                    const used = key.available_models.filter(m => usedModels.includes(m));
                    const notUsed = key.available_models.filter(m => !usedModels.includes(m));
                    
                    if (used.length > 0) {
                        modelsDisplay = `<strong>${used.join(', ')}</strong>`;
                        if (notUsed.length > 0) {
                            modelsDisplay += ` <span style="color: #3b82f6; cursor: pointer; font-weight: bold;" onclick="toggleModelsExpand('${rowId}')">+${notUsed.length}</span>`;
                        }
                    } else {
                        // –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 3
                        const firstThree = key.available_models.slice(0, 3).join(', ');
                        const remaining = key.available_models.length - 3;
                        modelsDisplay = firstThree;
                        if (remaining > 0) {
                            modelsDisplay += ` <span style="color: #3b82f6; cursor: pointer; font-weight: bold;" onclick="toggleModelsExpand('${rowId}')">+${remaining}</span>`;
                        }
                    }
                } else {
                    modelsDisplay = key.models_count ? `${key.models_count} –º–æ–¥–µ–ª–µ–π` : '‚Äî';
                }
                
                const statusText = {
                    'valid': '–í–∞–ª–∏–¥–µ–Ω',
                    'invalid': '–ù–µ–≤–∞–ª–∏–¥–µ–Ω',
                    'not_validated': '–ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω'
                };
                
                html += `
                    <tr id="${rowId}">
                        <td><strong>${providerName}</strong></td>
                        <td class="key-cell">${displayKey}</td>
                        <td><span class="status-badge ${key.status}">${statusText[key.status] || key.status}</span></td>
                        <td style="font-size: 11px;">${modelsDisplay}</td>
                        <td style="text-align: center;">
                            <input 
                                type="radio" 
                                name="primary_${key.provider}" 
                                class="primary-radio"
                                ${key.is_primary ? 'checked' : ''}
                                onchange="setPrimaryKey('${key.provider}', '${key.key_id}')"
                            >
                        </td>
                        <td style="text-align: center;">
                            <button 
                                onclick="deleteKey('${key.provider}', '${key.key_id}')"
                                style="background: #9b2d30; color: white; border: none; padding: 4px 12px; font-size: 12px; border-radius: 6px; cursor: pointer; transition: background 0.2s;"
                                onmouseover="this.style.background='#7a2326'" 
                                onmouseout="this.style.background='#9b2d30'"
                            >
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </td>
                    </tr>
                `;
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∏–π—Å—è —Ä—è–¥ —Å –ø–æ–ª–Ω—ã–º —Å–ø–∏—Å–∫–æ–º –º–æ–¥–µ–ª–µ–π
                if (isExpanded && key.available_models && key.available_models.length > 0) {
                    html += `
                        <tr id="${rowId}-expanded" style="background: #f9fafb;">
                            <td colspan="6" style="padding: 15px;">
                                <div style="font-size: 12px;">
                                    <strong>–í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏ (${key.available_models.length}):</strong>
                                    <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px;">
                                        ${key.available_models.map(m => {
                                            const isUsed = usedModels.includes(m);
                                            return `<span class="model-tag" style="background: ${isUsed ? '#dbeafe' : 'white'}; border-color: ${isUsed ? '#3b82f6' : '#d1d5db'}; font-weight: ${isUsed ? '600' : 'normal'};">${m}</span>`;
                                        }).join('')}
                                    </div>
                                    <div style="margin-top: 8px; font-size: 11px; color: #6b7280;">
                                        üí° –°–∏–Ω–∏–º –≤—ã–¥–µ–ª–µ–Ω—ã –º–æ–¥–µ–ª–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        function maskKey(key) {
            if (!key || key.length < 10) return '***';
            return key.substring(0, 5) + '***' + key.substring(key.length - 4);
        }
        
        function toggleModelsExpand(rowId) {
            if (expandedModelsRows.has(rowId)) {
                expandedModelsRows.delete(rowId);
            } else {
                expandedModelsRows.add(rowId);
            }
            renderKeysTable();
        }
        
        function toggleAllKeysVisibility() {
            showFullKeys = !showFullKeys;
            const btn = document.getElementById('toggleKeysBtn');
            btn.textContent = showFullKeys ? 'üôà –°–∫—Ä—ã—Ç—å –∫–ª—é—á–∏' : 'üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–ª—é—á–∏';
            renderKeysTable();
        }
        
        async function addKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const messageDiv = document.getElementById('addKeyMessage');
            
            if (!apiKey) {
                showMessage(messageDiv, '–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á', 'error');
                return;
            }
            
            // –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
            const providerSelect = document.getElementById('providerSelect');
            if (apiKey.startsWith('pplx-')) {
                providerSelect.value = 'perplexity';
            } else if (apiKey.startsWith('sk-proj-') || apiKey.startsWith('sk-') && !apiKey.startsWith('sk-or-')) {
                // OpenAI –∫–ª—é—á–∏: sk- –∏–ª–∏ sk-proj-
                // –ò—Å–∫–ª—é—á–∞–µ–º DeepSeek (–æ–±—ã—á–Ω–æ sk-or-...)
                if (providerSelect.value !== 'deepseek') {
                    providerSelect.value = 'openai';
                }
            }
            
            const provider = providerSelect.value;
            
            messageDiv.innerHTML = '<div class="loading"></div> –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞...';
            
            try {
                // –°–ù–ê–ß–ê–õ–ê –°–û–•–†–ê–ù–Ø–ï–ú –∫–ª—é—á —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω"
                const saveResponse = await fetch('/api_keys/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        provider, 
                        api_key: apiKey,
                        models_count: 0,
                        available_models: []
                    })
                });
                
                const saveData = await saveResponse.json();
                
                if (!saveData.success) {
                    showMessage(messageDiv, `‚ùå ${saveData.error}`, 'error');
                    return;
                }
                
                showMessage(messageDiv, '‚úÖ –ö–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏...', 'success');
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                document.getElementById('apiKeyInput').value = '';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Å—Ä–∞–∑—É
                loadKeys();
                
                // –ó–ê–¢–ï–ú –ø—ã—Ç–∞–µ–º—Å—è –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ)
                try {
                    const validateResponse = await fetch('/api_keys/validate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ provider, api_key: apiKey })
                    });
                    
                    const validateData = await validateResponse.json();
                    
                    if (validateData.success) {
                        showMessage(messageDiv, `‚úÖ –ö–ª—é—á –≤–∞–ª–∏–¥–µ–Ω! –ù–∞–π–¥–µ–Ω–æ –º–æ–¥–µ–ª–µ–π: ${validateData.models ? validateData.models.length : 0}`, 'success');
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª—é—á–µ
                        setTimeout(() => {
                            loadKeys();
                            messageDiv.innerHTML = '';
                        }, 2000);
                    } else {
                        showMessage(messageDiv, `‚ö†Ô∏è –ö–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω, –Ω–æ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞: ${validateData.error}. –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–≥–æ –ø–æ–∑–∂–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "–ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–ª—é—á–∏".`, 'error');
                        
                        setTimeout(() => {
                            loadKeys();
                            messageDiv.innerHTML = '';
                        }, 5000);
                    }
                } catch (validateError) {
                    console.warn('–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–∫–ª—é—á —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω):', validateError);
                    showMessage(messageDiv, '‚ö†Ô∏è –ö–ª—é—á –¥–æ–±–∞–≤–ª–µ–Ω, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–ª—é—á–∏" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–∑–∂–µ.', 'error');
                    
                    setTimeout(() => {
                        loadKeys();
                        messageDiv.innerHTML = '';
                    }, 5000);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞:', error);
                showMessage(messageDiv, `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
        
        async function setPrimaryKey(provider, keyId) {
            try {
                const response = await fetch('/api_keys/set_primary', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider, key_id: keyId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á –æ–±–Ω–æ–≤–ª—ë–Ω');
                    loadKeys();
                } else {
                    alert(`–û—à–∏–±–∫–∞: ${data.error}`);
                    loadKeys(); // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–ª—é—á–∞:', error);
                alert(`–û—à–∏–±–∫–∞: ${error.message}`);
                loadKeys();
            }
        }
        
        async function deleteKey(provider, keyId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç API –∫–ª—é—á?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api_keys/delete/${provider}/${keyId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadKeys();
                } else {
                    alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${data.error}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª—é—á–∞:', error);
                alert(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }
        
        async function refreshAllKeys() {
            const btn = document.getElementById('refreshKeysBtn');
            const messageDiv = document.getElementById('refreshMessage');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="loading" style="display: inline-block; margin-right: 5px;"></div> –ê–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è...';
            messageDiv.innerHTML = '';
            
            try {
                const response = await fetch('/api_keys/refresh_all', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                await loadKeys();
                
                if (data.success && data.invalid_count === 0) {
                    // –í—Å–µ –∫–ª—é—á–∏ –≤–∞–ª–∏–¥–Ω—ã
                    const successMsg = `
                        <div class="message success" style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <strong>‚úÖ –ê–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</strong><br>
                                –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${data.updated_count} –∫–ª—é—á–µ–π<br>
                                –í–∞–ª–∏–¥–Ω—ã—Ö: ${data.valid_count} | –ù–µ–≤–∞–ª–∏–¥–Ω—ã—Ö: ${data.invalid_count}
                            </div>
                            <button onclick="document.getElementById('refreshMessage').innerHTML=''" style="background: none; border: none; cursor: pointer; font-size: 18px; opacity: 0.7;">√ó</button>
                        </div>
                    `;
                    messageDiv.innerHTML = successMsg;
                    
                    // –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Å—Ç–∞–µ—Ç—Å—è –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –∫—Ä–µ—Å—Ç–∏–∫–æ–º –∏–ª–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    
                    btn.innerHTML = '‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 2000);
                } else {
                    // –ï—Å—Ç—å –æ—à–∏–±–∫–∏
                    let errorsHtml = '';
                    if (data.errors && data.errors.length > 0) {
                        errorsHtml = '<ul style="margin: 10px 0; padding-left: 20px;">';
                        data.errors.forEach(err => {
                            errorsHtml += `<li><strong>${err.provider}</strong> (${err.key}): ${err.error}</li>`;
                        });
                        errorsHtml += '</ul>';
                    }
                    
                    const errorMsg = `
                        <div class="message error" style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <strong>‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏</strong><br>
                                –í—Å–µ–≥–æ –∫–ª—é—á–µ–π: ${data.total_count} | –í–∞–ª–∏–¥–Ω—ã—Ö: ${data.valid_count} | –ù–µ–≤–∞–ª–∏–¥–Ω—ã—Ö: ${data.invalid_count}
                                ${errorsHtml}
                                <small style="color: #6b7280; display: block; margin-top: 8px;">
                                    üí° –°–æ–≤–µ—Ç: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á–∏ –Ω–∞ https://platform.openai.com/api-keys –∏–ª–∏ https://platform.deepseek.com/api_keys
                                </small>
                            </div>
                            <button onclick="document.getElementById('refreshMessage').innerHTML=''" style="background: none; border: none; cursor: pointer; font-size: 18px; opacity: 0.7; margin-left: 10px;">√ó</button>
                        </div>
                    `;
                    messageDiv.innerHTML = errorMsg;
                    
                    // –û—à–∏–±–∫–∏ –Ω–µ —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - –Ω—É–∂–Ω–æ –≤—Ä–µ–º—è –Ω–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
                    
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–ª—é—á–µ–π:', error);
                const errorMsg = `
                    <div class="message error">
                        <strong>‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞</strong><br>
                        ${error.message}
                    </div>
                `;
                messageDiv.innerHTML = errorMsg;
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        function showMessage(div, text, type) {
            div.innerHTML = `<div class="message ${type}">${text}</div>`;
        }
        
        function showTableError(error) {
            document.getElementById('keysTableContainer').innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 48px;">‚ö†Ô∏è</div>
                    <div style="margin-top: 10px; color: #ef4444;">${error}</div>
                </div>
            `;
        }
    </script>
</body>
</html>
